{% extends 'base.html' %}
{% load static %}

{% block title %}Kho Content & Ads - V-Medical{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-dark mb-0">KHO TÀI NGUYÊN ADS</h4>
    <button class="btn btn-primary fw-bold shadow-sm" onclick="openModal()">
        <i class="bi bi-plus-circle me-2"></i>THÊM CONTENT MỚI
    </button>
</div>

<div class="card card-box mb-4">
    <div class="card-body">
        <form method="GET" class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Tìm tên bài, headline, người làm..." value="{{ search_query }}">
            <button class="btn btn-dark" type="submit"><i class="bi bi-search"></i> Tìm kiếm</button>
        </form>
    </div>
</div>

<div class="row g-3">
    {% for ad in ads %}
    <div class="col-md-6 col-lg-4">
        <div class="card card-box h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-3 d-flex justify-content-between align-items-start">
                <h6 class="fw-bold text-primary mb-0 text-truncate" title="{{ ad.title }}">
                    <i class="bi bi-collection-play me-2"></i>{{ ad.title }}
                </h6>
                <div class="dropdown">
                    <button class="btn btn-light btn-sm rounded-circle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="editAd('{{ ad.id }}')">Sửa</a></li>
                        <li>
                            <form action="{% url 'content_ads_delete' ad.id %}" method="POST" onsubmit="return confirm('Xóa bài này?');">
                                {% csrf_token %}
                                <button class="dropdown-item text-danger">Xóa</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="card-body pt-0">
                <div class="small text-muted mb-2">{{ ad.created_at|date:"d/m/Y" }}</div>
                
                {% if ad.ad_headline %}
                <div class="alert alert-light border p-2 mb-2 small fst-italic text-dark">
                    "{{ ad.ad_headline }}"
                </div>
                {% endif %}

                <div class="d-flex gap-2 mb-3 text-secondary small flex-wrap">
                    <span class="badge bg-info bg-opacity-10 text-info border border-info" title="Content"><i class="bi bi-pen-fill"></i> {{ ad.content_creator.username|default:"--" }}</span>
                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning" title="Editor"><i class="bi bi-film"></i> {{ ad.editor.username|default:"--" }}</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary" title="Marketer"><i class="bi bi-graph-up-arrow"></i> {{ ad.marketer.username|default:"--" }}</span>
                </div>

                <div class="d-grid gap-2">
                    {% if ad.link_video %}
                        <a href="{{ ad.link_video }}" target="_blank" class="btn btn-sm btn-outline-danger text-start"><i class="bi bi-google-play me-2"></i>Link Video Gốc</a>
                    {% endif %}
                    {% if ad.link_thumb %}
                        <a href="{{ ad.link_thumb }}" target="_blank" class="btn btn-sm btn-outline-secondary text-start"><i class="bi bi-image me-2"></i>Link Thumbnail</a>
                    {% endif %}
                </div>

                {% if ad.result_note %}
                <div class="mt-3 pt-2 border-top">
                    <label class="small fw-bold text-success"><i class="bi bi-check-circle me-1"></i>Kết quả chạy:</label>
                    <p class="small text-muted mb-0">{{ ad.result_note }}</p>
                </div>
                {% endif %}
                
                <div class="d-none" id="data-{{ ad.id }}">
                    {{ ad.ad_headline }}|||{{ ad.post_content }}|||{{ ad.link_video }}|||{{ ad.link_thumb }}|||{{ ad.result_note }}|||{{ ad.content_creator.id }}|||{{ ad.editor.id }}|||{{ ad.marketer.id }}|||{{ ad.title }}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5 text-muted">Chưa có dữ liệu content ads.</div>
    {% endfor %}
</div>

<div class="modal fade" id="adModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalTitle">THÊM CONTENT MỚI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="ad_id" id="adId">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold small text-muted">Tên Ads (Mã quản lý) *</label>
                            {{ form.title }}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">NV Content</label>
                            {{ form.content_creator }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">NV Editor</label>
                            {{ form.editor }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">Marketer chạy</label>
                            {{ form.marketer }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Headline (Tiêu đề)</label>
                        {{ form.ad_headline }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Nội dung Post</label>
                        {{ form.post_content }}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Link Video Gốc</label>
                            {{ form.link_video }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted">Link Thumbnail</label>
                            {{ form.link_thumb }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-success">Kết quả chạy (Optional)</label>
                        {{ form.result_note }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary fw-bold">LƯU THÔNG TIN</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chuyển JS xuống đây để đảm bảo Bootstrap đã load xong
    var adModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        adModal = new bootstrap.Modal(document.getElementById('adModal'));
    });

    function openModal() {
        document.getElementById('adId').value = '';
        document.getElementById('modalTitle').innerText = "THÊM CONTENT MỚI";
        document.querySelector('form').reset();
        adModal.show();
    }

    function editAd(id) {
        var dataString = document.getElementById('data-' + id).innerText;
        var parts = dataString.split('|||');
        
        document.getElementById('adId').value = id;
        document.getElementById('modalTitle').innerText = "CẬP NHẬT CONTENT";
        
        // Điền dữ liệu (dùng try-catch để tránh lỗi nếu dữ liệu trống)
        try {
            document.querySelector('[name="ad_headline"]').value = parts[0].trim();
            document.querySelector('[name="post_content"]').value = parts[1].trim();
            document.querySelector('[name="link_video"]').value = parts[2].trim();
            document.querySelector('[name="link_thumb"]').value = parts[3].trim();
            document.querySelector('[name="result_note"]').value = parts[4].trim();
            
            // Dropdown (cần check nếu có giá trị)
            if(parts[5].trim()) document.querySelector('[name="content_creator"]').value = parts[5].trim();
            if(parts[6].trim()) document.querySelector('[name="editor"]').value = parts[6].trim();
            if(parts[7].trim()) document.querySelector('[name="marketer"]').value = parts[7].trim();
            
            document.querySelector('[name="title"]').value = parts[8].trim();
        } catch(e) {
            console.log("Lỗi điền form: ", e);
        }

        adModal.show();
    }
</script>
{% endblock %}