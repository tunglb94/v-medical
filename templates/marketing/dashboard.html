{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Marketing Dashboard - V-Medical{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h4 class="fw-bold text-dark mb-0">MARKETING CENTER</h4>
    
    <div class="d-flex gap-2 flex-wrap justify-content-end">
        <form method="GET" class="d-flex gap-2 bg-white p-1 rounded border shadow-sm flex-wrap align-items-center">
            <input type="date" name="date_start" class="form-control border-0 form-control-sm" style="width: 110px;" value="{{ date_start }}">
            <span class="align-self-center text-muted">-</span>
            <input type="date" name="date_end" class="form-control border-0 form-control-sm" style="width: 110px;" value="{{ date_end }}">
            
            <select name="platform" class="form-select border-start form-select-sm" style="width: 130px;">
                <option value="">-- Nguồn --</option>
                {% for code, label in platform_choices %}
                <option value="{{ code }}" {% if platform_query == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <input type="text" name="marketer" class="form-control border-start form-control-sm" placeholder="Tìm người chạy..." value="{{ marketer_query }}" style="width: 120px;">
            <input type="text" name="service" class="form-control border-start form-control-sm" placeholder="Tìm dịch vụ..." value="{{ service_query }}" style="width: 120px;">
            
            <button class="btn btn-sm btn-dark"><i class="bi bi-filter"></i></button>
        </form>
        
        <button class="btn btn-primary btn-sm fw-bold shadow-sm" type="button" onclick="openForm()">
            <i class="bi bi-plus-lg me-1"></i> NHẬP SỐ LIỆU
        </button>
    </div>
</div>

<div class="collapse mb-4" id="inputForm">
    <div class="card border-0 shadow-sm border-top border-primary border-4">
        <div class="card-body bg-light">
            <h6 class="fw-bold text-primary mb-3" id="formTitle">NHẬP BÁO CÁO MỚI</h6>
            <form method="POST" class="row g-3" id="marketingForm">
                {% csrf_token %}
                <input type="hidden" name="stat_id" id="statId">
                
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Ngày báo cáo</label>
                    {{ form.report_date }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-primary">Nền tảng (Source)</label>
                    {{ form.platform }} </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Người chạy Ads</label>
                    {{ form.marketer }}
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Dịch vụ / Campaign</label>
                    {{ form.service }}
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-danger">Ngân sách (VNĐ)</label>
                    {{ form.spend_amount }}
                </div>
                
                <div class="col-12"><hr class="my-1 text-muted opacity-25"></div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Hiển thị (Impr)</label>
                    {{ form.impressions }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Lượt Click</label>
                    {{ form.clicks }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Xem Video (View)</label>
                    {{ form.views }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Bình luận</label>
                    {{ form.comments }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Tin nhắn (Inbox)</label>
                    {{ form.inboxes }}
                </div>

                <div class="col-md-2">
                    <label class="small fw-bold text-primary">Leads (SĐT)</label>
                    {{ form.leads }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-success">Lịch hẹn</label>
                    {{ form.appointments }}
                </div>
                
                <div class="col-md-8 d-flex align-items-end justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#inputForm">Đóng</button>
                    <button type="submit" class="btn btn-success fw-bold px-4" id="btnSave">LƯU BÁO CÁO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row g-2 mb-4">
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-primary p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">CHI TIÊU</div>
            <h5 class="fw-bold text-primary mb-0">{{ totals.sum_spend|intcomma }} <span class="fs-6 text-muted">đ</span></h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-warning p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">TỔNG LEADS</div>
            <h5 class="fw-bold text-dark mb-0">{{ totals.sum_leads|intcomma }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-danger p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">GIÁ SỐ (CPL)</div>
            <h5 class="fw-bold text-danger mb-0">{{ avg_cpl|floatformat:0|intcomma }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-info p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">GIÁ CLICK (CPC)</div>
            <h5 class="fw-bold text-info mb-0">{{ avg_cpc|floatformat:0|intcomma }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-secondary p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">CTR TB</div>
            <h5 class="fw-bold text-secondary mb-0">{{ avg_ctr|floatformat:2 }}%</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-success p-2 ps-3">
            <div class="text-muted small fw-bold mb-1">LỊCH HẸN</div>
            <h5 class="fw-bold text-success mb-0">{{ totals.sum_appts }}</h5>
        </div>
    </div>
</div>

<div class="card card-box mb-4">
    <div class="card-body">
        <div style="height: 300px;"><canvas id="marketingChart"></canvas></div>
    </div>
</div>

<div class="card card-box mb-4 shadow-sm border-0 border-start border-4 border-info">
    <div class="card-header bg-white py-3">
        <h6 class="fw-bold text-info m-0"><i class="bi bi-person-badge-fill me-2"></i>HIỆU QUẢ THEO NHÂN SỰ ADS (MARKETER)</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped mb-0 text-center align-middle">
                <thead class="bg-info bg-opacity-10 text-dark">
                    <tr>
                        <th class="text-start ps-4">Marketer</th>
                        <th class="text-end">Chi tiêu</th>
                        <th>Leads</th>
                        <th class="text-end">Giá Lead (CPL)</th>
                        <th class="text-end">Doanh thu</th>
                        <th class="text-end pe-4">ROAS (Ads/DT)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in report_marketers %}
                    <tr>
                        <td class="text-start ps-4 fw-bold text-primary">{{ item.name }}</td>
                        <td class="text-end fw-bold">{{ item.spend|intcomma }} đ</td>
                        <td><span class="badge bg-white text-dark border shadow-sm px-3">{{ item.leads }}</span></td>
                        <td class="text-end text-muted">{{ item.cpl|floatformat:0|intcomma }} đ</td>
                        
                        <td class="text-end fw-bold text-success">{{ item.revenue|intcomma }} đ</td>
                        
                        <td class="text-end pe-4 fw-bold {% if item.roas > 40 %}text-danger{% else %}text-success{% endif %}">
                            {{ item.roas|floatformat:1 }}%
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-muted py-3 fst-italic">Chưa có dữ liệu thống kê.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card card-box shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 small text-center table-bordered border-light">
            <thead class="bg-light text-secondary">
                <tr>
                    <th class="py-3 text-start ps-3">Ngày</th>
                    <th class="text-start">Nguồn</th> <th class="text-start" style="min-width: 150px;">Chiến dịch / Dịch vụ</th>
                    <th class="text-end">Ngân sách</th>
                    
                    <th class="bg-light-info">Hiển thị</th>
                    <th class="bg-light-info">Click</th>
                    <th class="bg-light-info">CTR</th>
                    <th class="bg-light-info text-end">CPC</th>
                    
                    <th>Leads</th>
                    <th class="text-end text-danger">CPL</th>
                    <th>Hẹn</th>
                    <th>#</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats %}
                <tr>
                    <td class="text-start ps-3 fw-bold text-nowrap">{{ stat.report_date|date:"d/m" }}</td>
                    
                    <td class="text-start">
                        {% if stat.platform == 'FACEBOOK' %}<span class="badge bg-primary">FB Ads</span>
                        {% elif stat.platform == 'GOOGLE' %}<span class="badge bg-danger">Google</span>
                        {% elif stat.platform == 'TIKTOK' %}<span class="badge bg-dark">Tiktok</span>
                        {% elif stat.platform == 'ZALO' %}<span class="badge bg-info text-dark">Zalo</span>
                        {% else %}<span class="badge bg-secondary">{{ stat.get_platform_display }}</span>{% endif %}
                        <div class="text-muted fst-italic" style="font-size: 0.75rem;">{{ stat.marketer }}</div>
                    </td>

                    <td class="text-start text-muted">{{ stat.service|default:"--" }}</td>
                    <td class="text-end fw-bold">{{ stat.spend_amount|intcomma }}</td>
                    
                    <td class="text-muted">{{ stat.impressions|intcomma }}</td>
                    <td class="text-muted">{{ stat.clicks|intcomma }}</td>
                    <td class="fw-bold text-primary">{{ stat.ctr|floatformat:2 }}%</td>
                    <td class="text-end text-muted">{{ stat.cpc|floatformat:0|intcomma }}</td>

                    <td class="fw-bold fs-6">{{ stat.leads }}</td>
                    <td class="text-end text-danger fw-bold">{{ stat.cost_per_lead|floatformat:0|intcomma }}</td>
                    <td class="fw-bold text-success">{{ stat.appointments }}</td>
                    
                    <td>
                        <button class="btn btn-sm btn-light text-warning border" 
                                onclick="editReport(this)"
                                data-id="{{ stat.id }}"
                                data-date="{{ stat.report_date|date:'Y-m-d' }}"
                                data-platform="{{ stat.platform }}" 
                                data-marketer="{{ stat.marketer|default:'' }}"
                                data-service="{{ stat.service|default:'' }}"
                                data-spend="{{ stat.spend_amount|stringformat:'d' }}"
                                
                                data-impr="{{ stat.impressions }}"
                                data-clicks="{{ stat.clicks }}"
                                data-views="{{ stat.views }}"
                                
                                data-comments="{{ stat.comments }}" 
                                data-inboxes="{{ stat.inboxes }}"
                                data-leads="{{ stat.leads }}" 
                                data-appointments="{{ stat.appointments }}">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        
                        <form action="{% url 'delete_marketing_report' stat.id %}" method="POST" class="d-inline" onsubmit="return confirm('Bạn chắc chắn muốn xóa dòng này?');">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-light text-danger border"><i class="bi bi-trash-fill"></i></button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="12" class="py-5 text-muted">Chưa có dữ liệu báo cáo nào.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{{ chart_dates|json_script:"j-dates" }}
{{ chart_cpl|json_script:"j-cpl" }}
{{ chart_leads|json_script:"j-leads" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if(document.getElementById('j-dates')) {
            function getData(id) { return JSON.parse(document.getElementById(id).textContent); }
            new Chart(document.getElementById('marketingChart'), {
                type: 'bar',
                data: {
                    labels: getData('j-dates'),
                    datasets: [
                        { label: 'Leads', data: getData('j-leads'), type: 'bar', backgroundColor: '#3498db', borderRadius: 4, order: 2 },
                        { label: 'CPL (VNĐ)', data: getData('j-cpl'), type: 'line', borderColor: '#e74c3c', borderWidth: 2, tension: 0.3, order: 1, yAxisID: 'y1' }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'bottom' } },
                    scales: { 
                        y: { beginAtZero: true, title: {display: true, text: 'Số Leads'} },
                        y1: { position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: 'Chi phí CPL'} }
                    } 
                }
            });
        }
    });

    function openForm() {
        document.getElementById('marketingForm').reset();
        document.getElementById('statId').value = ''; 
        document.getElementById('formTitle').innerText = "NHẬP SỐ LIỆU MỚI";
        document.getElementById('btnSave').innerText = "LƯU BÁO CÁO";
        document.getElementById('btnSave').className = "btn btn-success fw-bold px-4";
        
        new bootstrap.Collapse(document.getElementById('inputForm'), { show: true });
        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }

    function editReport(button) {
        // Điền dữ liệu cũ vào form
        document.getElementById('statId').value = button.getAttribute('data-id');
        document.querySelector('[name="report_date"]').value = button.getAttribute('data-date');
        
        // Load thêm Platform & Metrics mới
        document.querySelector('[name="platform"]').value = button.getAttribute('data-platform');
        document.querySelector('[name="impressions"]').value = button.getAttribute('data-impr');
        document.querySelector('[name="clicks"]').value = button.getAttribute('data-clicks');
        document.querySelector('[name="views"]').value = button.getAttribute('data-views');

        document.querySelector('[name="marketer"]').value = button.getAttribute('data-marketer');
        document.querySelector('[name="service"]').value = button.getAttribute('data-service');
        document.querySelector('[name="spend_amount"]').value = button.getAttribute('data-spend');
        document.querySelector('[name="comments"]').value = button.getAttribute('data-comments');
        document.querySelector('[name="inboxes"]').value = button.getAttribute('data-inboxes');
        document.querySelector('[name="leads"]').value = button.getAttribute('data-leads');
        document.querySelector('[name="appointments"]').value = button.getAttribute('data-appointments');

        // Đổi trạng thái form
        document.getElementById('formTitle').innerText = "CẬP NHẬT SỐ LIỆU";
        var btn = document.getElementById('btnSave');
        btn.innerText = "CẬP NHẬT";
        btn.className = "btn btn-warning fw-bold px-4";

        new bootstrap.Collapse(document.getElementById('inputForm'), { show: true });
        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}