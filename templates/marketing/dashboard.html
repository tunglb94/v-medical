{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Dashboard - V-Medical</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .kpi-card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; background: white; }
        .kpi-card:hover { transform: translateY(-5px); }
        .trend-up { color: #198754; font-weight: bold; font-size: 0.85rem; }
        .trend-down { color: #dc3545; font-weight: bold; font-size: 0.85rem; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .fw-bolder { font-weight: 800 !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 mb-4 shadow-sm">
  <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
      <img src="{% static 'images/logo.png' %}" alt="Logo" height="40" class="d-inline-block align-text-top me-2 bg-white rounded p-1">
      MARKETING CENTER
  </a>
  <div class="ms-auto d-flex gap-2 text-white align-items-center">
      <div class="d-none d-md-flex gap-2 me-3">
          <a href="/" class="btn btn-sm btn-outline-light">Telesale</a>
          <a href="{% url 'reception_home' %}" class="btn btn-sm btn-outline-light">Lễ tân</a>
          <a href="{% url 'sales_report' %}" class="btn btn-sm btn-outline-light">Doanh thu</a>
      </div>
      <div class="vr bg-secondary mx-2"></div>
      <div class="fw-bold me-3">{{ request.user.username }}</div>
      <a href="{% url 'logout' %}" class="btn btn-sm btn-danger"><i class="bi bi-power"></i></a>
  </div>
</nav>

<div class="container-fluid px-4 pb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <form method="GET" class="d-flex gap-2 bg-white p-2 rounded shadow-sm">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light border-0 fw-bold">Từ</span>
                <input type="date" name="date_start" class="form-control border-0" value="{{ date_start }}">
            </div>
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light border-0 fw-bold">Đến</span>
                <input type="date" name="date_end" class="form-control border-0" value="{{ date_end }}">
            </div>
            <button class="btn btn-sm btn-dark px-3"><i class="bi bi-filter"></i> Lọc</button>
        </form>
        
        <button class="btn btn-primary fw-bold shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#inputForm" onclick="resetForm()">
            <i class="bi bi-pencil-square me-2"></i> NHẬP BÁO CÁO NGÀY
        </button>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="collapse mb-4" id="inputForm">
        <div class="card border-0 shadow-sm border-top border-primary border-4">
            <div class="card-body bg-light">
                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-clipboard-data me-2"></i>NHẬP / CHỈNH SỬA SỐ LIỆU</h6>
                
                <form method="POST" class="row g-3 align-items-end" id="marketingForm">
                    {% csrf_token %}
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted mb-1">Ngày báo cáo</label>
                        {{ form.report_date }}
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted mb-1">Ngân sách (VNĐ)</label>
                        {{ form.spend_amount }}
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted mb-1">Số Comment</label>
                        {{ form.comments }}
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted mb-1">Số Inbox</label>
                        {{ form.inboxes }}
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-primary mb-1">SĐT (Leads)</label>
                        {{ form.leads }}
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-success mb-1">Lịch hẹn</label>
                        {{ form.appointments }}
                    </div>
                    <div class="col-12 text-end mt-3">
                        <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#inputForm">Đóng</button>
                        <button type="submit" class="btn btn-success fw-bold px-4 shadow-sm" id="btnSave">
                            <i class="bi bi-save me-1"></i> LƯU BÁO CÁO
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card kpi-card h-100 border-start border-5 border-primary"><div class="card-body"><div class="text-muted small fw-bold text-uppercase mb-1">Tổng Ngân Sách</div><h3 class="fw-bold text-primary mb-0">{{ totals.sum_spend|intcomma }} <span class="fs-6 text-muted fw-normal">đ</span></h3></div></div></div>
        <div class="col-md-3"><div class="card kpi-card h-100 border-start border-5 border-warning"><div class="card-body"><div class="text-muted small fw-bold text-uppercase mb-1">Tổng Leads (SĐT)</div><h3 class="fw-bold text-dark mb-0">{{ totals.sum_leads|intcomma }} <span class="fs-6 text-muted fw-normal">số</span></h3></div></div></div>
        <div class="col-md-3"><div class="card kpi-card h-100 border-start border-5 border-danger"><div class="card-body"><div class="text-muted small fw-bold text-uppercase mb-1">Giá CPL Trung Bình</div><h3 class="fw-bold text-danger mb-0">{{ avg_cpl|floatformat:0|intcomma }} <span class="fs-6 text-muted fw-normal">đ/số</span></h3></div></div></div>
        <div class="col-md-3"><div class="card kpi-card h-100 border-start border-5 border-success"><div class="card-body"><div class="text-muted small fw-bold text-uppercase mb-1">Tổng Lịch Hẹn</div><h3 class="fw-bold text-success mb-0">{{ totals.sum_appts }} <span class="fs-6 text-muted fw-normal">lịch</span></h3></div></div></div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white fw-bold py-3 border-bottom"><i class="bi bi-graph-up me-2 text-primary"></i>XU HƯỚNG HIỆU QUẢ (LEADS vs CPL)</div>
        <div class="card-body"><div style="height: 350px;"><canvas id="marketingChart"></canvas></div></div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center border-bottom">
            <span><i class="bi bi-table me-2 text-success"></i>CHI TIẾT THEO NGÀY</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center">
                <thead class="table-light text-secondary small text-uppercase">
                    <tr>
                        <th class="text-start ps-4 py-3">Ngày</th>
                        <th class="text-end">Ngân sách</th>
                        <th>Tương tác</th>
                        <th>SĐT (Leads)</th>
                        <th class="text-end">Giá CPL</th>
                        <th>Tỷ lệ số</th>
                        <th>Lịch hẹn</th>
                        <th>Tỷ lệ chốt</th>
                        <th>Thao tác</th> </tr>
                </thead>
                <tbody>
                    {% for stat in stats %}
                    <tr>
                        <td class="text-start ps-4 fw-bold text-primary">{{ stat.report_date|date:"d/m/Y" }}</td>
                        <td class="text-end">{{ stat.spend_amount|intcomma }} đ</td>
                        <td>{{ stat.total_interactions }}</td>
                        
                        <td class="fw-bolder" style="font-size: 1.1rem;">
                            {{ stat.leads }}
                            <br>
                            {% if stat.trend_lead > 0 %}<span class="trend-up"><i class="bi bi-caret-up-fill"></i> {{ stat.trend_lead|floatformat:0 }}%</span>
                            {% elif stat.trend_lead < 0 %}<span class="trend-down"><i class="bi bi-caret-down-fill"></i> {{ stat.trend_lead|floatformat:0 }}%</span>
                            {% else %}<span class="text-muted small">-</span>{% endif %}
                        </td>

                        <td class="text-end fw-bold text-danger">{{ stat.cost_per_lead|floatformat:0|intcomma }}</td>
                        <td>{{ stat.conversion_rate_lead|floatformat:1 }}%</td>
                        <td class="fw-bold text-success">{{ stat.appointments }}</td>
                        <td>
                            {% if stat.conversion_rate_appt >= 50 %}<span class="badge bg-success rounded-pill">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>
                            {% elif stat.conversion_rate_appt >= 30 %}<span class="badge bg-warning text-dark rounded-pill">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>
                            {% else %}<span class="badge bg-danger rounded-pill">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>{% endif %}
                        </td>
                        
                        <td>
                            <button class="btn btn-sm btn-warning shadow-sm" title="Sửa"
                                onclick="editReport(this)"
                                data-date="{{ stat.report_date|date:'Y-m-d' }}"
                                data-spend="{{ stat.spend_amount|stringformat:'d' }}" 
                                data-comments="{{ stat.comments }}"
                                data-inboxes="{{ stat.inboxes }}"
                                data-leads="{{ stat.leads }}"
                                data-appointments="{{ stat.appointments }}">
                                <i class="bi bi-pencil-fill"></i>
                            </button>

                            <form action="{% url 'delete_marketing_report' stat.id %}" method="POST" class="d-inline" onsubmit="return confirm('Bạn chắc chắn muốn xóa báo cáo ngày {{ stat.report_date }}?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger shadow-sm" title="Xóa"><i class="bi bi-trash-fill"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="py-5 text-muted">Chưa có dữ liệu báo cáo nào.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

{{ chart_dates|json_script:"j-dates" }}
{{ chart_cpl|json_script:"j-cpl" }}
{{ chart_leads|json_script:"j-leads" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function getData(id) { return JSON.parse(document.getElementById(id).textContent); }
        const ctx = document.getElementById('marketingChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: getData('j-dates'),
                datasets: [
                    { label: 'Leads', data: getData('j-leads'), type: 'bar', backgroundColor: 'rgba(13, 110, 253, 0.7)', order: 2, yAxisID: 'y', borderRadius: 4 },
                    { label: 'CPL (VNĐ)', data: getData('j-cpl'), type: 'line', borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', borderWidth: 3, pointRadius: 4, fill: false, tension: 0.3, order: 1, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Số lượng Leads', color: '#0d6efd' } },
                    y1: { type: 'linear', display: true, position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Chi phí CPL', color: '#dc3545' } }
                }
            }
        });
    });

    // --- HÀM XỬ LÝ SỬA BÁO CÁO ---
    function editReport(button) {
        // 1. Mở form
        var collapseElement = document.getElementById('inputForm');
        var bsCollapse = new bootstrap.Collapse(collapseElement, { show: true });

        // 2. Lấy dữ liệu từ data-attributes
        // Lưu ý: Dữ liệu số đã được stringformat:'d' để loại bỏ dấu phẩy
        var date = button.getAttribute('data-date');
        var spend = button.getAttribute('data-spend'); 
        var comments = button.getAttribute('data-comments');
        var inboxes = button.getAttribute('data-inboxes');
        var leads = button.getAttribute('data-leads');
        var appointments = button.getAttribute('data-appointments');

        // 3. Điền vào form (Selector theo name)
        document.querySelector('[name="report_date"]').value = date;
        document.querySelector('[name="spend_amount"]').value = spend;
        document.querySelector('[name="comments"]').value = comments;
        document.querySelector('[name="inboxes"]').value = inboxes;
        document.querySelector('[name="leads"]').value = leads;
        document.querySelector('[name="appointments"]').value = appointments;

        // 4. Cuộn lên đầu & Đổi nút
        collapseElement.scrollIntoView({ behavior: 'smooth' });
        var btnSave = document.getElementById('btnSave');
        btnSave.className = "btn btn-warning fw-bold px-4 shadow-sm";
        btnSave.innerHTML = "<i class='bi bi-pencil-square me-1'></i> CẬP NHẬT";
    }

    // --- HÀM RESET FORM (Về trạng thái thêm mới) ---
    function resetForm() {
        document.getElementById('marketingForm').reset();
        
        // Reset ngày về hôm nay (Optional)
        // document.querySelector('[name="report_date"]').valueAsDate = new Date();

        var btnSave = document.getElementById('btnSave');
        btnSave.className = "btn btn-success fw-bold px-4 shadow-sm";
        btnSave.innerHTML = "<i class='bi bi-save me-1'></i> LƯU BÁO CÁO";
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>