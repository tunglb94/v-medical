{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Marketing Dashboard - V-Medical{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-dark mb-0">MARKETING CENTER</h4>
    
    <div class="d-flex gap-2">
        <form method="GET" class="d-flex gap-2 bg-white p-1 rounded border">
            <input type="date" name="date_start" class="form-control border-0 form-control-sm" value="{{ date_start }}">
            <span class="align-self-center text-muted">-</span>
            <input type="date" name="date_end" class="form-control border-0 form-control-sm" value="{{ date_end }}">
            <button class="btn btn-sm btn-dark"><i class="bi bi-filter"></i></button>
        </form>
        
        <button class="btn btn-primary btn-sm fw-bold shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#inputForm" onclick="resetForm()">
            <i class="bi bi-plus-lg me-1"></i> NHẬP BÁO CÁO
        </button>
    </div>
</div>

<div class="collapse mb-4" id="inputForm">
    <div class="card border-0 shadow-sm border-top border-primary border-4">
        <div class="card-body bg-light">
            <form method="POST" class="row g-3 align-items-end" id="marketingForm">
                {% csrf_token %}
                <div class="col-md-2"><label class="small fw-bold text-muted">Ngày</label>{{ form.report_date }}</div>
                <div class="col-md-2"><label class="small fw-bold text-muted">Chi tiêu</label>{{ form.spend_amount }}</div>
                <div class="col-md-2"><label class="small fw-bold text-muted">Comment</label>{{ form.comments }}</div>
                <div class="col-md-2"><label class="small fw-bold text-muted">Inbox</label>{{ form.inboxes }}</div>
                <div class="col-md-2"><label class="small fw-bold text-primary">Leads</label>{{ form.leads }}</div>
                <div class="col-md-2"><label class="small fw-bold text-success">Lịch hẹn</label>{{ form.appointments }}</div>
                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-success fw-bold px-4" id="btnSave">LƯU BÁO CÁO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-primary p-3">
            <div class="text-muted small fw-bold mb-1">CHI TIÊU</div>
            <h4 class="fw-bold text-primary mb-0">{{ totals.sum_spend|intcomma }} <span class="fs-6 text-muted">đ</span></h4>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-warning p-3">
            <div class="text-muted small fw-bold mb-1">LEADS</div>
            <h4 class="fw-bold text-dark mb-0">{{ totals.sum_leads|intcomma }}</h4>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-danger p-3">
            <div class="text-muted small fw-bold mb-1">GIÁ SỐ (CPL)</div>
            <h4 class="fw-bold text-danger mb-0">{{ avg_cpl|floatformat:0|intcomma }}</h4>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-success p-3">
            <div class="text-muted small fw-bold mb-1">LỊCH HẸN</div>
            <h4 class="fw-bold text-success mb-0">{{ totals.sum_appts }}</h4>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-info p-3">
            <div class="text-muted small fw-bold mb-1">GIÁ HẸN (CPA)</div>
            <h4 class="fw-bold text-info mb-0">{{ avg_cpa|floatformat:0|intcomma }}</h4>
        </div>
    </div>
</div>

<div class="card card-box mb-4">
    <div class="card-body">
        <div style="height: 300px;"><canvas id="marketingChart"></canvas></div>
    </div>
</div>

<div class="card card-box">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 text-center">
            <thead class="bg-light text-secondary small">
                <tr>
                    <th class="py-3 text-start ps-4">Ngày</th>
                    <th>Chi tiêu</th>
                    <th>Tương tác</th>
                    <th>Leads</th>
                    <th>Giá CPL</th>
                    <th>Giá Hẹn</th>
                    <th>Lịch hẹn</th>
                    <th>Chốt</th>
                    <th>#</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats %}
                <tr>
                    <td class="text-start ps-4 fw-bold text-primary">{{ stat.report_date|date:"d/m" }}</td>
                    <td>{{ stat.spend_amount|intcomma }}</td>
                    <td>{{ stat.total_interactions }}</td>
                    <td class="fw-bold">{{ stat.leads }}</td>
                    <td class="text-danger fw-bold">{{ stat.cost_per_lead|floatformat:0|intcomma }}</td>
                    <td class="text-info fw-bold">{{ stat.cost_per_appointment|floatformat:0|intcomma }}</td>
                    <td class="text-success fw-bold">{{ stat.appointments }}</td>
                    <td>
                        {% if stat.conversion_rate_appt >= 30 %}<span class="badge bg-success">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>
                        {% else %}<span class="badge bg-secondary">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>{% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-light text-warning border" onclick="editReport(this)"
                            data-date="{{ stat.report_date|date:'Y-m-d' }}"
                            data-spend="{{ stat.spend_amount|stringformat:'d' }}"
                            data-comments="{{ stat.comments }}" data-inboxes="{{ stat.inboxes }}"
                            data-leads="{{ stat.leads }}" data-appointments="{{ stat.appointments }}">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{{ chart_dates|json_script:"j-dates" }}
{{ chart_cpl|json_script:"j-cpl" }}
{{ chart_leads|json_script:"j-leads" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if(document.getElementById('j-dates')) {
            function getData(id) { return JSON.parse(document.getElementById(id).textContent); }
            new Chart(document.getElementById('marketingChart'), {
                type: 'bar',
                data: {
                    labels: getData('j-dates'),
                    datasets: [
                        { label: 'Leads', data: getData('j-leads'), type: 'bar', backgroundColor: '#3498db', borderRadius: 4 },
                        { label: 'CPL', data: getData('j-cpl'), type: 'line', borderColor: '#e74c3c', borderWidth: 2, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
    });

    function editReport(button) {
        var collapseElement = document.getElementById('inputForm');
        new bootstrap.Collapse(collapseElement, { show: true });
        
        document.querySelector('[name="report_date"]').value = button.getAttribute('data-date');
        document.querySelector('[name="spend_amount"]').value = button.getAttribute('data-spend');
        document.querySelector('[name="comments"]').value = button.getAttribute('data-comments');
        document.querySelector('[name="inboxes"]').value = button.getAttribute('data-inboxes');
        document.querySelector('[name="leads"]').value = button.getAttribute('data-leads');
        document.querySelector('[name="appointments"]').value = button.getAttribute('data-appointments');

        collapseElement.scrollIntoView({ behavior: 'smooth' });
        var btnSave = document.getElementById('btnSave');
        btnSave.className = "btn btn-warning fw-bold px-4";
        btnSave.innerText = "CẬP NHẬT";
    }

    function resetForm() {
        document.getElementById('marketingForm').reset();
        var btnSave = document.getElementById('btnSave');
        btnSave.className = "btn btn-success fw-bold px-4";
        btnSave.innerText = "LƯU BÁO CÁO";
    }
</script>
{% endblock %}