{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Marketing Dashboard - V-Medical{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h4 class="fw-bold text-dark mb-0">MARKETING CENTER</h4>
    
    <div class="d-flex gap-2 flex-wrap justify-content-end">
        <form method="GET" class="d-flex gap-2 bg-white p-1 rounded border shadow-sm flex-wrap">
            <input type="date" name="date_start" class="form-control border-0 form-control-sm" style="width: 110px;" value="{{ date_start }}">
            <span class="align-self-center text-muted">-</span>
            <input type="date" name="date_end" class="form-control border-0 form-control-sm" style="width: 110px;" value="{{ date_end }}">
            
            <input type="text" name="marketer" class="form-control border-start form-control-sm" placeholder="Tìm người chạy..." value="{{ marketer_query }}" style="width: 120px;">
            <input type="text" name="service" class="form-control border-start form-control-sm" placeholder="Tìm dịch vụ..." value="{{ service_query }}" style="width: 120px;">
            
            <button class="btn btn-sm btn-dark"><i class="bi bi-filter"></i></button>
        </form>
        
        <button class="btn btn-primary btn-sm fw-bold shadow-sm" type="button" onclick="openForm()">
            <i class="bi bi-plus-lg me-1"></i> NHẬP SỐ LIỆU
        </button>
    </div>
</div>

<div class="collapse mb-4" id="inputForm">
    <div class="card border-0 shadow-sm border-top border-primary border-4">
        <div class="card-body bg-light">
            <h6 class="fw-bold text-primary mb-3" id="formTitle">NHẬP BÁO CÁO MỚI</h6>
            <form method="POST" class="row g-3" id="marketingForm">
                {% csrf_token %}
                <input type="hidden" name="stat_id" id="statId">
                
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Ngày báo cáo</label>
                    {{ form.report_date }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Người chạy Ads</label>
                    {{ form.marketer }}
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Dịch vụ / Campaign</label>
                    {{ form.service }}
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-danger">Ngân sách (VNĐ)</label>
                    {{ form.spend_amount }}
                </div>
                
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Comment</label>
                    {{ form.comments }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted">Inbox</label>
                    {{ form.inboxes }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-primary">Leads (SĐT)</label>
                    {{ form.leads }}
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-success">Lịch hẹn</label>
                    {{ form.appointments }}
                </div>
                
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-success fw-bold w-100" id="btnSave">LƯU BÁO CÁO</button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#inputForm">Đóng</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-primary p-3">
            <div class="text-muted small fw-bold mb-1">CHI TIÊU</div>
            <h5 class="fw-bold text-primary mb-0">{{ totals.sum_spend|intcomma }} <span class="fs-6 text-muted">đ</span></h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-warning p-3">
            <div class="text-muted small fw-bold mb-1">TỔNG LEADS</div>
            <h5 class="fw-bold text-dark mb-0">{{ totals.sum_leads|intcomma }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-danger p-3">
            <div class="text-muted small fw-bold mb-1">GIÁ SỐ (CPL)</div>
            <h5 class="fw-bold text-danger mb-0">{{ avg_cpl|floatformat:0|intcomma }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-success p-3">
            <div class="text-muted small fw-bold mb-1">LỊCH HẸN</div>
            <h5 class="fw-bold text-success mb-0">{{ totals.sum_appts }}</h5>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-box h-100 border-start border-4 border-info p-3">
            <div class="text-muted small fw-bold mb-1">GIÁ HẸN (CPA)</div>
            <h5 class="fw-bold text-info mb-0">{{ avg_cpa|floatformat:0|intcomma }}</h5>
        </div>
    </div>
</div>

<div class="card card-box mb-4">
    <div class="card-body">
        <div style="height: 300px;"><canvas id="marketingChart"></canvas></div>
    </div>
</div>

<div class="card card-box">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 small text-center">
            <thead class="bg-light text-secondary">
                <tr>
                    <th class="py-3 text-start ps-4">Ngày</th>
                    <th class="text-start">Người chạy</th>
                    <th class="text-start">Dịch vụ</th>
                    <th class="text-end">Ngân sách</th>
                    <th>Tương tác</th>
                    <th>Leads</th>
                    <th class="text-end">CPL</th>
                    <th>Hẹn</th>
                    <th>Chốt %</th>
                    <th>#</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats %}
                <tr>
                    <td class="text-start ps-4 fw-bold">{{ stat.report_date|date:"d/m" }}</td>
                    <td class="text-start fw-bold text-primary">{{ stat.marketer|default:"--" }}</td>
                    <td class="text-start text-muted">{{ stat.service|default:"--" }}</td>
                    <td class="text-end fw-bold">{{ stat.spend_amount|intcomma }}</td>
                    <td>{{ stat.total_interactions }}</td>
                    <td class="fw-bold fs-6">{{ stat.leads }}</td>
                    <td class="text-end text-danger fw-bold">{{ stat.cost_per_lead|floatformat:0|intcomma }}</td>
                    <td class="fw-bold text-success">{{ stat.appointments }}</td>
                    <td>
                        {% if stat.conversion_rate_appt >= 30 %}<span class="text-success fw-bold">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>
                        {% else %}<span class="text-muted">{{ stat.conversion_rate_appt|floatformat:0 }}%</span>{% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-light text-warning border" 
                                onclick="editReport(this)"
                                data-id="{{ stat.id }}"
                                data-date="{{ stat.report_date|date:'Y-m-d' }}"
                                data-marketer="{{ stat.marketer|default:'' }}"
                                data-service="{{ stat.service|default:'' }}"
                                data-spend="{{ stat.spend_amount|stringformat:'d' }}"
                                data-comments="{{ stat.comments }}" 
                                data-inboxes="{{ stat.inboxes }}"
                                data-leads="{{ stat.leads }}" 
                                data-appointments="{{ stat.appointments }}">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        
                        <form action="{% url 'delete_marketing_report' stat.id %}" method="POST" class="d-inline" onsubmit="return confirm('Bạn chắc chắn muốn xóa dòng này?');">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-light text-danger border"><i class="bi bi-trash-fill"></i></button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="10" class="py-5 text-muted">Chưa có dữ liệu báo cáo.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{{ chart_dates|json_script:"j-dates" }}
{{ chart_cpl|json_script:"j-cpl" }}
{{ chart_leads|json_script:"j-leads" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if(document.getElementById('j-dates')) {
            function getData(id) { return JSON.parse(document.getElementById(id).textContent); }
            new Chart(document.getElementById('marketingChart'), {
                type: 'bar',
                data: {
                    labels: getData('j-dates'),
                    datasets: [
                        { label: 'Leads', data: getData('j-leads'), type: 'bar', backgroundColor: '#3498db', borderRadius: 4, order: 2 },
                        { label: 'CPL (VNĐ)', data: getData('j-cpl'), type: 'line', borderColor: '#e74c3c', borderWidth: 2, tension: 0.3, order: 1, yAxisID: 'y1' }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: true, title: {display: true, text: 'Số Leads'} },
                        y1: { position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: 'Chi phí CPL'} }
                    } 
                }
            });
        }
    });

    function openForm() {
        document.getElementById('marketingForm').reset();
        document.getElementById('statId').value = ''; // Xóa ID để thành Thêm mới
        document.getElementById('formTitle').innerText = "NHẬP SỐ LIỆU MỚI";
        document.getElementById('btnSave').innerText = "LƯU BÁO CÁO";
        document.getElementById('btnSave').className = "btn btn-success fw-bold w-100";
        
        new bootstrap.Collapse(document.getElementById('inputForm'), { show: true });
        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }

    function editReport(button) {
        // Điền dữ liệu cũ vào form
        document.getElementById('statId').value = button.getAttribute('data-id');
        document.querySelector('[name="report_date"]').value = button.getAttribute('data-date');
        document.querySelector('[name="marketer"]').value = button.getAttribute('data-marketer');
        document.querySelector('[name="service"]').value = button.getAttribute('data-service');
        document.querySelector('[name="spend_amount"]').value = button.getAttribute('data-spend');
        document.querySelector('[name="comments"]').value = button.getAttribute('data-comments');
        document.querySelector('[name="inboxes"]').value = button.getAttribute('data-inboxes');
        document.querySelector('[name="leads"]').value = button.getAttribute('data-leads');
        document.querySelector('[name="appointments"]').value = button.getAttribute('data-appointments');

        // Đổi trạng thái form
        document.getElementById('formTitle').innerText = "CẬP NHẬT SỐ LIỆU";
        var btn = document.getElementById('btnSave');
        btn.innerText = "CẬP NHẬT";
        btn.className = "btn btn-warning fw-bold w-100";

        new bootstrap.Collapse(document.getElementById('inputForm'), { show: true });
        document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}