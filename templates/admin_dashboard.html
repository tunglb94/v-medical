{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 mb-1 text-gray-800 fw-bold"><i class="bi bi-speedometer2 me-2"></i>Dashboard Tổng Quan</h2>
            <p class="text-muted small mb-0">Tổng hợp dữ liệu từ {{ date_start }} đến {{ date_end }}</p>
        </div>
        
        <form method="get" class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light"><i class="bi bi-calendar-event"></i></span>
                <input type="date" name="date_start" class="form-control" value="{{ date_start }}">
            </div>
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light"><i class="bi bi-arrow-right"></i></span>
                <input type="date" name="date_end" class="form-control" value="{{ date_end }}">
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-3 fw-bold">Lọc Dữ Liệu</button>
        </form>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Doanh thu kỳ này</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ revenue_current|intcomma }} đ</div>
                            <div class="mt-2 text-xs text-muted">
                                {% if growth_rate >= 0 %}
                                    <span class="text-success fw-bold"><i class="bi bi-arrow-up"></i> {{ growth_rate|floatformat:1 }}%</span> so với kỳ trước
                                {% else %}
                                    <span class="text-danger fw-bold"><i class="bi bi-arrow-down"></i> {{ growth_rate|floatformat:1 }}%</span> so với kỳ trước
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-currency-dollar text-gray-300 display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Khách hàng mới (Leads)</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ leads_total }}</div>
                            <div class="mt-2 text-xs text-muted">Data đổ về hệ thống</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-plus-fill text-gray-300 display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tổng Lịch Hẹn</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ appts_total }}</div>
                            <div class="mt-2 text-xs text-muted">
                                Đã đến: <strong>{{ appts_arrived }}</strong>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-check-fill text-gray-300 display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Tỷ lệ đến khám</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ arrival_rate|floatformat:1 }}%</div>
                            <div class="progress progress-sm mt-2">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ arrival_rate }}%" aria-valuenow="{{ arrival_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-percent text-gray-300 display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <h6 class="font-weight-bold text-primary mb-3"><i class="bi bi-funnel-fill me-2"></i>Phễu Chuyển Đổi Vận Hành</h6>
            <div class="row text-center align-items-center">
                <div class="col position-relative">
                    <div class="h5 fw-bold text-secondary mb-1">{{ leads_total }}</div>
                    <div class="small text-muted text-uppercase">Data Mới</div>
                    <i class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y text-muted d-none d-md-block"></i>
                </div>
                <div class="col position-relative">
                    <div class="h5 fw-bold text-info mb-1">{{ calls_total }}</div>
                    <div class="small text-muted text-uppercase">Cuộc Gọi</div>
                    <i class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y text-muted d-none d-md-block"></i>
                </div>
                <div class="col position-relative">
                    <div class="h5 fw-bold text-primary mb-1">{{ appts_total }}</div>
                    <div class="small text-muted text-uppercase">Đặt Hẹn</div>
                    <i class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y text-muted d-none d-md-block"></i>
                </div>
                <div class="col">
                    <div class="h5 fw-bold text-success mb-1">{{ appts_arrived }}</div>
                    <div class="small text-muted text-uppercase">Khách Đến</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Biểu Đồ Xu Hướng Doanh Thu</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area" style="height: 320px;">
                        <canvas id="myAreaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Top Dịch Vụ (Doanh số)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="height: 250px;">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small text-muted">
                        <span class="me-2">
                            <i class="bi bi-circle-fill text-primary"></i> Dịch vụ top 1
                        </span>
                        <span class="me-2">
                            <i class="bi bi-circle-fill text-success"></i> Top 2
                        </span>
                        <span class="me-2">
                            <i class="bi bi-circle-fill text-info"></i> Top 3
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-person-badge-fill me-2"></i>HIỆU SUẤT TƯ VẤN VIÊN ({{ date_start }} - {{ date_end }})</h6>
                    <small class="text-muted">Thống kê vận hành theo bộ lọc</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle mb-0 text-center">
                            <thead class="bg-light text-secondary">
                                <tr>
                                    <th class="text-start ps-4">Tư vấn viên</th>
                                    <th>Được phân bổ</th>
                                    <th>Check-in</th>
                                    <th class="text-success">Thành công</th>
                                    <th class="text-danger">Thất bại</th>
                                    <th>TB/Khách</th> <th>Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in consultant_stats_filtered %}
                                <tr>
                                    <td class="text-start ps-4 fw-bold text-dark">{{ sale.name }}</td>
                                    <td><span class="badge bg-secondary">{{ sale.assigned }}</span></td>
                                    <td><span class="badge bg-info text-dark">{{ sale.checkin }}</span></td>
                                    <td><span class="badge bg-success">{{ sale.success }}</span></td>
                                    <td>
                                        {% if sale.failed > 0 %}
                                            <span class="badge bg-danger">{{ sale.failed }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold text-info">{{ sale.avg_revenue|intcomma }}</td>
                                    <td class="text-end pe-4 fw-bold text-success">{{ sale.revenue|intcomma }} đ</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">Chưa có dữ liệu cho khoảng thời gian này</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-info"><i class="bi bi-headset me-2"></i>Top Telesale (Online)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Nhân viên</th>
                                    <th class="text-end pe-4">Doanh số</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tele in top_telesales %}
                                <tr>
                                    <td class="ps-4 fw-bold text-dark">
                                        {{ tele.name }}
                                    </td>
                                    <td class="text-end pe-4 text-success fw-bold">{{ tele.total|intcomma }} đ</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center py-3 text-muted">Chưa có dữ liệu</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
             <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-clock-history me-2"></i>Đơn Hàng Gần Đây</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Khách hàng</th>
                                    <th class="text-end pe-4">Giá trị</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-dark small">{{ order.customer.name }}</div>
                                        <div class="text-muted small" style="font-size: 0.75rem;">{{ order.created_at|date:"d/m H:i" }}</div>
                                    </td>
                                    <td class="text-end pe-4 fw-bold text-primary small">{{ order.total_amount|intcomma }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center py-3 text-muted">Chưa có đơn hàng</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set new default font family and font color to mimic Bootstrap's default styling
    Chart.defaults.font.family = 'Nunito, -apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
    Chart.defaults.color = '#858796';

    // 1. AREA CHART (Revenue Trend)
    const ctxArea = document.getElementById("myAreaChart");
    new Chart(ctxArea, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: "Doanh thu",
                lineTension: 0.3,
                backgroundColor: "rgba(78, 115, 223, 0.05)",
                borderColor: "rgba(78, 115, 223, 1)",
                pointRadius: 3,
                pointBackgroundColor: "rgba(78, 115, 223, 1)",
                pointBorderColor: "rgba(78, 115, 223, 1)",
                pointHoverRadius: 3,
                pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                pointHitRadius: 10,
                pointBorderWidth: 2,
                data: {{ chart_data|safe }},
                fill: true,
            }],
        },
        options: {
            maintainAspectRatio: false,
            layout: { padding: { left: 10, right: 25, top: 25, bottom: 0 } },
            scales: {
                x: { grid: { display: false, drawBorder: false }, ticks: { maxTicksLimit: 7 } },
                y: { 
                    ticks: { maxTicksLimit: 5, padding: 10, callback: function(value) { return value.toLocaleString() + 'đ'; } },
                    grid: { color: "rgb(234, 236, 244)", zeroLineColor: "rgb(234, 236, 244)", drawBorder: false, borderDash: [2], zeroLineBorderDash: [2] }
                },
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyColor: "#858796",
                    titleColor: '#6e707e',
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    padding: 15,
                    displayColors: false,
                    intersect: false,
                    mode: 'index',
                    caretPadding: 10,
                    callbacks: {
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.y !== null) { label += context.parsed.y.toLocaleString() + ' đ'; }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // 2. PIE CHART (Top Services)
    const ctxPie = document.getElementById("myPieChart");
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: {{ service_labels|safe }},
            datasets: [{
                data: {{ service_data|safe }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                     callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.parsed || 0;
                            return label + ': ' + value.toLocaleString() + ' đ';
                        }
                    }
                }
            },
            cutout: '70%',
        },
    });
</script>
{% endblock %}