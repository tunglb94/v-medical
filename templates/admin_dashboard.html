{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Giám Đốc - V-Medical{% endblock %}

{% block extra_css %}
<style>
    .kpi-card-pro {
        background: white; 
        border: none; 
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.03); 
        padding: 20px;
        position: relative; 
        overflow: hidden; 
        transition: transform 0.3s;
    }
    .kpi-card-pro:hover { 
        transform: translateY(-3px); 
    }
    .kpi-label { 
        font-size: 0.85rem; 
        color: #6c757d; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        font-weight: 600; 
    }
    .kpi-value { 
        font-size: 1.8rem; 
        font-weight: 800; 
        color: #2c3e50; 
        margin: 5px 0; 
    }
    .kpi-badge { 
        font-size: 0.75rem; 
        padding: 4px 8px; 
        border-radius: 6px; 
        font-weight: 600; 
        display: inline-block; 
    }
    .bg-soft-success { 
        background-color: rgba(25, 135, 84, 0.1); 
        color: #198754; 
    }
    .bg-soft-danger { 
        background-color: rgba(220, 53, 69, 0.1); 
        color: #dc3545; 
    }
    
    .icon-shape {
        width: 45px; 
        height: 45px; 
        border-radius: 10px;
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 1.5rem; 
        position: absolute; 
        top: 20px; 
        right: 20px; 
        opacity: 0.2;
    }
    
    .table-top-staff td { 
        padding: 12px 15px; 
    }
    
    /* Đã tách dòng để tránh lỗi CSS */
    .rank-1 { 
        color: #ffc107; 
    }
    .rank-2 { 
        color: #adb5bd; 
    } 
    .rank-3 { 
        color: #cd7f32; 
    }
</style>
{% endblock %}

{% block content %}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end mb-4 gap-3">
        <div>
            <h6 class="text-muted mb-1 text-uppercase fw-bold">Tổng quan điều hành</h6>
            <h3 class="fw-bold text-dark mb-0">Dashboard Giám Đốc</h3>
        </div>
        
        <div class="bg-white p-2 rounded shadow-sm">
            <form method="GET" class="d-flex align-items-center gap-2">
                <span class="small fw-bold text-muted text-uppercase px-1">Xem từ:</span>
                <input type="date" name="date_start" class="form-control form-control-sm border-0 bg-light fw-bold text-primary" style="width: 130px;" value="{{ date_start }}">
                <span class="small fw-bold text-muted">-</span>
                <input type="date" name="date_end" class="form-control form-control-sm border-0 bg-light fw-bold text-primary" style="width: 130px;" value="{{ date_end }}">
                <button type="submit" class="btn btn-primary btn-sm fw-bold"><i class="bi bi-funnel-fill"></i> Lọc</button>
            </form>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card-pro border-bottom border-4 border-success">
                <div class="kpi-label">Doanh Thu Trong Kỳ</div>
                <div class="kpi-value">{{ revenue_current|intcomma }} <span class="fs-6 text-muted">đ</span></div>
                
                {% if growth_rate >= 0 %}
                    <span class="kpi-badge bg-soft-success"><i class="bi bi-arrow-up-right"></i> +{{ growth_rate|floatformat:1 }}%</span>
                {% else %}
                    <span class="kpi-badge bg-soft-danger"><i class="bi bi-arrow-down-right"></i> {{ growth_rate|floatformat:1 }}%</span>
                {% endif %}
                <span class="small text-muted ms-1">so với kỳ trước</span>
                
                <div class="icon-shape bg-success text-success"><i class="bi bi-currency-dollar"></i></div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3">
            <div class="kpi-card-pro border-bottom border-4 border-primary">
                <div class="kpi-label">Data Khách Mới</div>
                <div class="kpi-value">{{ leads_total }} <span class="fs-6 text-muted">khách</span></div>
                <span class="small text-muted">Lead mới tạo trong kỳ</span>
                <div class="icon-shape bg-primary text-primary"><i class="bi bi-person-plus-fill"></i></div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3">
            <div class="kpi-card-pro border-bottom border-4 border-warning">
                <div class="kpi-label">Tỷ Lệ Khách Đến</div>
                <div class="kpi-value">{{ arrival_rate|floatformat:0 }}%</div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ arrival_rate }}%"></div>
                </div>
                <div class="icon-shape bg-warning text-warning"><i class="bi bi-geo-alt-fill"></i></div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3">
            <div class="kpi-card-pro border-bottom border-4 border-info">
                <div class="kpi-label">Tổng Lịch Hẹn</div>
                <div class="kpi-value">{{ appts_total }} <span class="fs-6 text-muted">lịch</span></div>
                <span class="small text-muted">Đã đến: <strong>{{ appts_arrived }}</strong> khách</span>
                <div class="icon-shape bg-info text-info"><i class="bi bi-calendar-week-fill"></i></div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card card-box h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0 text-primary"><i class="bi bi-graph-up me-2"></i>BIỂU ĐỒ DOANH THU</h6>
                </div>
                <div class="card-body">
                    <div style="height: 320px;">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card card-box h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold m-0 text-dark"><i class="bi bi-pie-chart-fill me-2"></i>CƠ CẤU DỊCH VỤ</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="height: 280px; width: 100%;">
                        <canvas id="servicePieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card card-box h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold m-0 text-warning"><i class="bi bi-trophy-fill me-2"></i>TOP SALE XUẤT SẮC</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 table-top-staff">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-4">Hạng</th>
                                <th>Nhân viên</th>
                                <th class="text-end pe-4">Doanh số</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in top_sales %}
                            <tr>
                                <td class="ps-4 fw-bold">
                                    {% if forloop.counter == 1 %}<i class="bi bi-trophy-fill rank-1 fs-5"></i>
                                    {% elif forloop.counter == 2 %}<i class="bi bi-medal-fill rank-2 fs-5"></i>
                                    {% elif forloop.counter == 3 %}<i class="bi bi-medal-fill rank-3 fs-5"></i>
                                    {% else %}#{{ forloop.counter }}{% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle fw-bold text-secondary d-flex align-items-center justify-content-center me-2" style="width:32px; height:32px;">
                                            {{ sale.sale_consultant__username|slice:":1"|upper }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ sale.sale_consultant__last_name }} {{ sale.sale_consultant__first_name }}</div>
                                            <div class="small text-muted">{{ sale.sale_consultant__username }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end pe-4 fw-bold text-success">{{ sale.total|intcomma }} đ</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center py-4 text-muted">Chưa có dữ liệu trong kỳ này.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-box h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0 text-info"><i class="bi bi-clock-history me-2"></i>GIAO DỊCH TRONG KỲ</h6>
                    <a href="{% url 'sales_report' %}" class="btn btn-sm btn-light text-primary fw-bold">Chi tiết</a>
                </div>
                <div class="list-group list-group-flush">
                    {% for order in recent_orders %}
                    <div class="list-group-item border-0 border-bottom py-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="d-flex align-items-center">
                                {% if order.customer.ranking == 'DIAMOND' %}<i class="bi bi-gem text-info me-2" title="VIP"></i>
                                {% elif order.customer.ranking == 'GOLD' %}<i class="bi bi-star-fill text-warning me-2" title="VIP"></i>
                                {% else %}<i class="bi bi-person-fill text-secondary me-2"></i>{% endif %}
                                
                                <span class="fw-bold text-dark">{{ order.customer.name }}</span>
                            </div>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success">+{{ order.total_amount|intcomma }}</span>
                        </div>
                        <div class="d-flex justify-content-between small text-muted">
                            <span>{{ order.treatment_name }}</span>
                            <span>{{ order.created_at|date:"H:i d/m" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">Chưa có giao dịch nào.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ chart_labels|json_script:"j-labels" }}
    {{ chart_data|json_script:"j-data" }}
    {{ service_labels|json_script:"j-sv-labels" }}
    {{ service_data|json_script:"j-sv-data" }}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Revenue Trend Chart
            const labels = JSON.parse(document.getElementById('j-labels').textContent);
            const data = JSON.parse(document.getElementById('j-data').textContent);
            
            new Chart(document.getElementById('revenueTrendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu', data: data,
                        borderColor: '#198754', backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        borderWidth: 2, pointRadius: 3, fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [5] } }, x: { grid: { display: false } } } }
            });

            // 2. Service Pie Chart
            const svLabels = JSON.parse(document.getElementById('j-sv-labels').textContent);
            const svData = JSON.parse(document.getElementById('j-sv-data').textContent);
            
            new Chart(document.getElementById('servicePieChart'), {
                type: 'doughnut',
                data: {
                    labels: svLabels,
                    datasets: [{
                        data: svData,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } 
                    },
                    cutout: '70%' 
                }
            });
        });
    </script>
{% endblock %}