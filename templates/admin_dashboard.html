{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Quản Trị - V-Medical{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-0">Tổng Quan</h3>
            <p class="text-muted mb-0">Xin chào, <span class="text-primary fw-bold">{{ request.user.username }}</span>!</p>
        </div>
        <div class="bg-white px-3 py-2 rounded shadow-sm fw-bold text-secondary">
            <i class="bi bi-calendar-event me-2"></i> {% now "l, d/m/Y" %}
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card card-box h-100 border-start border-4 border-success p-3">
                <div class="text-muted small fw-bold mb-1 text-uppercase">Doanh Thu Hôm Nay</div>
                <h3 class="fw-bold text-success mb-0">{{ revenue_today|intcomma }} <span class="fs-6 text-muted">đ</span></h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-box h-100 border-start border-4 border-primary p-3">
                <div class="text-muted small fw-bold mb-1 text-uppercase">Khách Đến / Hẹn</div>
                <h3 class="fw-bold text-primary mb-0">{{ appts_today_arrived }} <span class="fs-6 fw-normal text-muted">/ {{ appts_today_total }}</span></h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-box h-100 border-start border-4 border-info p-3">
                <div class="text-muted small fw-bold mb-1 text-uppercase">Telesale Gọi</div>
                <h3 class="fw-bold text-info mb-0">{{ calls_today }} <span class="fs-6 fw-normal text-muted">cuộc</span></h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-box h-100 border-start border-4 border-warning p-3">
                <div class="text-muted small fw-bold mb-1 text-uppercase">Data Mới</div>
                <h3 class="fw-bold text-dark mb-0">{{ leads_today }} <span class="fs-6 fw-normal text-muted">khách</span></h3>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card card-box h-100">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="fw-bold m-0 text-primary"><i class="bi bi-graph-up-arrow me-2"></i>XU HƯỚNG DOANH THU (7 NGÀY)</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card card-box h-100">
                <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0 text-secondary"><i class="bi bi-receipt me-2"></i>GIAO DỊCH MỚI</h6>
                    <a href="{% url 'sales_report' %}" class="small text-decoration-none">Xem tất cả</a>
                </div>
                <div class="list-group list-group-flush">
                    {% for order in recent_orders %}
                    <div class="list-group-item border-0 border-bottom py-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="fw-bold text-dark text-truncate" style="max-width: 150px;">{{ order.customer.name }}</div>
                            <div class="fw-bold text-success">+{{ order.total_amount|intcomma }}</div>
                        </div>
                        <div class="d-flex justify-content-between small text-muted">
                            <span>{{ order.treatment_name }}</span>
                            <span>{{ order.created_at|date:"H:i" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">Chưa có giao dịch nào.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ chart_labels|json_script:"chart-labels" }}
    {{ chart_data|json_script:"chart-data" }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const labels = JSON.parse(document.getElementById('chart-labels').textContent);
            const data = JSON.parse(document.getElementById('chart-data').textContent);
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: data,
                        borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 3, pointRadius: 4, fill: true, tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        });
    </script>
{% endblock %}