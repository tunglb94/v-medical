{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªÖ T√¢n - V-Medical Clinic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #eef2f7; font-family: 'Segoe UI', sans-serif; }
        .bg-teal { background-color: #009688; }
        .card-box { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: white; }
        .status-scheduled { border-left: 5px solid #0d6efd; background-color: #f8f9fa; }
        .status-arrived { border-left: 5px solid #ffc107; background-color: #fff3cd; }
        .status-completed { border-left: 5px solid #198754; background-color: #d1e7dd; }
        .status-cancelled { border-left: 5px solid #dc3545; opacity: 0.6; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-teal px-3 mb-4 shadow-sm">
  <a class="navbar-brand fw-bold d-flex align-items-center" href="/reception/">
      <img src="{% static 'images/logo.png' %}" alt="Logo" height="40" class="d-inline-block align-text-top me-2 bg-white rounded p-1">
      L·ªÑ T√ÇN V-MEDICAL
  </a>
  
  <div class="ms-auto text-white d-flex align-items-center">
      <div class="d-none d-md-flex gap-2 me-3">
          <a href="/" class="btn btn-sm btn-outline-light fw-bold"><i class="bi bi-headset me-1"></i> Telesale</a>
          <a href="{% url 'customer_list' %}" class="btn btn-sm btn-outline-light fw-bold"><i class="bi bi-people me-1"></i> Kh√°ch h√†ng</a>
          <a href="{% url 'sales_report' %}" class="btn btn-sm btn-outline-light fw-bold"><i class="bi bi-graph-up me-1"></i> B√°o c√°o</a>
      </div>
      <div class="me-3 text-end border-start ps-3">
          <div class="fw-bold">{{ request.user.username }}</div>
          <small class="opacity-75">L·ªÖ t√¢n</small>
      </div>
      <a href="{% url 'logout' %}" class="btn btn-sm btn-danger border-0 shadow-sm"><i class="bi bi-box-arrow-right"></i></a>
  </div>
</nav>

<div class="container-fluid px-4">
    <div class="row mb-4 align-items-center">
        <div class="col-12 col-md-7 d-flex flex-column flex-md-row gap-2 mb-3 mb-md-0">
            <form action="" method="GET" class="d-flex gap-2 flex-grow-1">
                <input type="text" name="q" class="form-control form-control-lg border-0 shadow-sm" 
                       placeholder="üîç T√¨m kh√°ch c≈© (T√™n/SƒêT)..." value="{{ search_query }}">
                <input type="hidden" name="date" value="{{ current_date|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-lg btn-primary shadow-sm px-3">T√¨m</button>
                {% if search_query %}
                    <a href="/reception/?date={{ current_date|date:'Y-m-d' }}" class="btn btn-lg btn-secondary shadow-sm">X√≥a</a>
                {% endif %}
            </form>
            
            <button class="btn btn-lg btn-warning text-dark fw-bold shadow-sm w-100 w-md-auto" data-bs-toggle="modal" data-bs-target="#walkinModal">
                <i class="bi bi-person-plus-fill me-1"></i> KH√ÅCH V√ÉNG LAI
            </button>
        </div>
        
        <div class="col-12 col-md-5 d-flex justify-content-between justify-content-md-end align-items-center">
            <div class="bg-white p-2 rounded shadow-sm d-flex align-items-center">
                <span class="text-muted me-2 fw-bold small text-uppercase">L·ªãch ng√†y:</span>
                <form method="GET" id="dateForm">
                    {% if search_query %}<input type="hidden" name="q" value="{{ search_query }}">{% endif %}
                    <input type="date" name="date" class="form-control fw-bold text-primary border-0 p-0" 
                           style="width: 140px;"
                           value="{{ current_date|date:'Y-m-d' }}" 
                           onchange="document.getElementById('dateForm').submit()">
                </form>
            </div>
            {% if current_date != today %}
                <a href="/reception/" class="btn btn-sm btn-outline-danger ms-2 fw-bold">V·ªÅ h√¥m nay</a>
            {% endif %}
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card card-box mb-4">
                <div class="card-header bg-white border-bottom pt-3 pb-2 d-flex justify-content-between">
                    <h5 class="fw-bold text-teal"><i class="bi bi-calendar-week me-2"></i>DANH S√ÅCH KH√ÅCH H·∫∏N</h5>
                    <span class="badge bg-secondary">{{ appointments.count }} kh√°ch</span>
                </div>
                <div class="card-body p-0">
                    {% if appointments %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-secondary">
                                    <tr>
                                        <th class="ps-4">Gi·ªù</th>
                                        <th>Kh√°ch h√†ng</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for app in appointments %}
                                    <tr class="
                                        {% if app.status == 'SCHEDULED' %}status-scheduled
                                        {% elif app.status == 'ARRIVED' %}status-arrived
                                        {% elif app.status == 'COMPLETED' %}status-completed
                                        {% else %}status-cancelled{% endif %}">
                                        
                                        <td class="ps-4 fw-bold text-primary" style="font-size: 1.1rem;">
                                            {{ app.appointment_date|date:"H:i" }}
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ app.customer.name }}</div>
                                            <div class="small text-muted">{{ app.customer.phone }}</div>
                                            <div class="small text-secondary fst-italic">{{ app.customer.get_skin_condition_display }}</div>
                                        </td>
                                        <td>
                                            {% if app.status == 'SCHEDULED' %}
                                                <span class="badge bg-primary">ƒê√£ ƒë·∫∑t</span>
                                            {% elif app.status == 'ARRIVED' %}
                                                <span class="badge bg-warning text-dark">ƒêang ch·ªù</span>
                                            {% elif app.status == 'COMPLETED' %}
                                                <span class="badge bg-success">Ho√†n th√†nh</span>
                                            {% else %}
                                                <span class="badge bg-secondary">ƒê√£ h·ªßy</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if app.status == 'SCHEDULED' %}
                                                <a href="{% url 'checkin' app.id %}" class="btn btn-sm btn-warning fw-bold shadow-sm">
                                                    <i class="bi bi-box-arrow-in-right me-1"></i> CHECK-IN
                                                </a>
                                            {% elif app.status == 'ARRIVED' %}
                                                <button class="btn btn-sm btn-success fw-bold shadow-sm"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#finishModal"
                                                        data-id="{{ app.id }}"
                                                        data-name="{{ app.customer.name }}">
                                                    <i class="bi bi-clipboard-check me-1"></i> CH·ªêT CA
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-light border" disabled>ƒê√£ xong</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-calendar-x display-4 opacity-25"></i>
                            <p class="mt-3">Kh√¥ng c√≥ l·ªãch h·∫πn n√†o trong ng√†y n√†y.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card card-box" style="min-height: 500px;">
                <div class="card-header bg-white border-bottom pt-3 pb-2">
                    <h5 class="fw-bold text-secondary"><i class="bi bi-search me-2"></i>K·∫æT QU·∫¢ T√åM KI·∫æM</h5>
                </div>
                <div class="card-body">
                    {% if search_query %}
                        {% if search_results %}
                            <div class="list-group">
                                {% for customer in search_results %}
                                    <div class="list-group-item list-group-item-action p-3 border-0 border-bottom">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1 fw-bold text-primary">{{ customer.name }}</h6>
                                            <small class="text-muted">{{ customer.phone }}</small>
                                        </div>
                                        <p class="mb-1 small text-muted">{{ customer.address|default:"Ch∆∞a c√≥ ƒë·ªãa ch·ªâ" }}</p>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary rounded-pill fw-bold"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#receptionBookingModal"
                                                    data-id="{{ customer.id }}" 
                                                    data-name="{{ customer.name }}">
                                                <i class="bi bi-plus-lg"></i> ƒê·∫∑t l·ªãch ngay
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center mt-5 text-muted">
                                <i class="bi bi-person-x fs-1"></i>
                                <p>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o.</p>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center mt-5 text-muted opacity-50">
                            <i class="bi bi-keyboard fs-1"></i>
                            <p>Nh·∫≠p t√™n ho·∫∑c SƒêT ƒë·ªÉ t√¨m ki·∫øm...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="walkinModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title fw-bold">KH√ÅCH V√ÉNG LAI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'reception_walkin' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body">
              <div class="alert alert-warning small mb-3">H·ªá th·ªëng t·ª± t·∫°o h·ªì s∆° n·∫øu SƒêT ch∆∞a t·ªìn t·∫°i.</div>
              <div class="mb-3">
                  <label class="form-label fw-bold">H·ªç T√™n <span class="text-danger">*</span></label>
                  <input type="text" name="name" class="form-control" required>
              </div>
              <div class="mb-3">
                  <label class="form-label fw-bold">SƒêT <span class="text-danger">*</span></label>
                  <input type="text" name="phone" class="form-control" required>
              </div>
              <div class="row mb-3">
                  <div class="col-md-4">
                      <label class="form-label fw-bold">Tu·ªïi</label>
                      <input type="number" name="age" class="form-control" placeholder="25">
                  </div>
                  <div class="col-md-8">
                      <label class="form-label fw-bold">T·ªânh Th√†nh</label>
                      <input class="form-control" list="provinceOptions" name="city" placeholder="Ch·ªçn t·ªânh...">
                  </div>
              </div>
              <div class="mb-3">
                  <label class="form-label fw-bold">Gi·ªù ƒë·∫øn</label>
                  <input type="datetime-local" name="appointment_date" class="form-control" required>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="submit" class="btn btn-warning fw-bold text-dark">T·∫†O & CHECK-IN</button>
          </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="receptionBookingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-teal text-white">
        <h5 class="modal-title fw-bold">ƒê·∫∑t l·ªãch nhanh</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'reception_create_appointment' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body">
              <input type="hidden" name="customer_id" id="modalBookingCustomerId">
              <div class="mb-3">
                  <label class="form-label">Kh√°ch h√†ng:</label>
                  <input type="text" class="form-control fw-bold bg-light" id="modalBookingCustomerName" readonly>
              </div>
              <div class="mb-3">
                  <label class="form-label fw-bold">Gi·ªù h·∫πn</label>
                  <input type="datetime-local" name="appointment_date" class="form-control" required>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="submit" class="btn btn-primary bg-teal border-0">X√°c nh·∫≠n</button>
          </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="finishModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-clipboard-check me-2"></i>CH·ªêT CA T∆Ø V·∫§N</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'reception_finish' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body bg-light">
              <input type="hidden" name="appointment_id" id="finishApptId">
              <div class="alert alert-info d-flex align-items-center py-2">
                  <i class="bi bi-person-bounding-box fs-4 me-3"></i>
                  <div><strong id="finishCustomerName" class="fs-5">T√™n Kh√°ch</strong></div>
              </div>

              <div class="card mb-3">
                  <div class="card-header fw-bold bg-white text-primary small">1. NH√ÇN S·ª∞ PH·ª§ TR√ÅCH</div>
                  <div class="card-body row g-2">
                      <div class="col-md-4">
                          <label class="form-label small fw-bold text-muted">B√°c sƒ© kh√°m</label>
                          <select name="doctor_id" class="form-select form-select-sm">
                              <option value="">-- Ch·ªçn --</option>
                              {% for doc in doctors %}
                                <option value="{{ doc.id }}">BS. {{ doc.last_name }} {{ doc.first_name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                      <div class="col-md-4">
                          <label class="form-label small fw-bold text-muted">K·ªπ thu·∫≠t vi√™n</label>
                          <select name="technician_id" class="form-select form-select-sm">
                              <option value="">-- Ch·ªçn --</option>
                              {% for tech in technicians %}
                                <option value="{{ tech.id }}">KTV. {{ tech.last_name }} {{ tech.first_name }}</option>
                              {% endfor %}
                          </select>
                      </div>
                      <div class="col-md-4">
                          <label class="form-label small fw-bold text-muted">Sale t∆∞ v·∫•n</label>
                          <select name="consultant_id" class="form-select form-select-sm">
                              <option value="">-- Ch·ªçn --</option>
                              {% for sale in consultants %}
                                <option value="{{ sale.id }}">{{ sale.last_name }} {{ sale.first_name }} ({{ sale.username }})</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header fw-bold bg-white text-danger small">2. K·∫æT QU·∫¢ GIAO D·ªäCH</div>
                  <div class="card-body">
                      <div class="mb-3 text-center">
                          <div class="btn-group w-100" role="group">
                              <input type="radio" class="btn-check" name="result_status" id="success" value="buy" checked onclick="toggleOrderForm(true)">
                              <label class="btn btn-outline-success fw-bold" for="success">CH·ªêT ƒê∆†N</label>
                              <input type="radio" class="btn-check" name="result_status" id="fail" value="no_buy" onclick="toggleOrderForm(false)">
                              <label class="btn btn-outline-secondary fw-bold" for="fail">KH√ÅCH T·ª™ CH·ªêI</label>
                          </div>
                      </div>

                      <div id="orderInfoBlock" class="p-3 bg-success bg-opacity-10 border border-success rounded">
                          <div class="mb-2">
                              <label class="form-label fw-bold small">D·ªãch v·ª• / Li·ªáu tr√¨nh</label>
                              <select name="service_id" id="serviceSelect" class="form-select" onchange="updatePrice()">
                                  <option value="" data-price="0">-- Ch·ªçn d·ªãch v·ª• --</option>
                                  {% for sv in services %}
                                    <option value="{{ sv.id }}" data-price="{{ sv.price|floatformat:0 }}">{{ sv.name }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                          
                          <div class="row g-2">
                              <div class="col-4">
                                  <label class="form-label small text-muted">Gi√° g·ªëc</label>
                                  <input type="number" name="original_price" id="originalPrice" class="form-control form-control-sm" readonly>
                              </div>
                              <div class="col-4">
                                  <label class="form-label small text-muted">Gi·∫£m gi√°</label>
                                  <input type="number" name="discount" id="discountInput" class="form-control form-control-sm" placeholder="0" oninput="calculateFinal()">
                              </div>
                              <div class="col-4">
                                  <label class="form-label small fw-bold text-danger">TH·ª∞C THU</label>
                                  <input type="number" name="total_amount" id="finalPrice" class="form-control form-control-sm fw-bold text-danger" readonly>
                              </div>
                          </div>
                      </div>

                      <div id="rejectionInfoBlock" class="p-3 bg-secondary bg-opacity-10 border border-secondary rounded" style="display: none;">
                          <textarea name="rejection_reason" id="rejectReason" class="form-control" rows="2" placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..."></textarea>
                      </div>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="submit" class="btn btn-success fw-bold">L∆ØU & HO√ÄN T·∫§T</button>
          </div>
      </form>
    </div>
  </div>
</div>

<datalist id="provinceOptions">
    <option value="H√† N·ªôi"><option value="TP. H·ªì Ch√≠ Minh"><option value="ƒê√† N·∫µng">
    <option value="H·∫£i Ph√≤ng"><option value="C·∫ßn Th∆°"><option value="B√¨nh D∆∞∆°ng"><option value="ƒê·ªìng Nai">
</datalist>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var bookingModal = document.getElementById('receptionBookingModal');
    if (bookingModal) {
        bookingModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('modalBookingCustomerId').value = button.getAttribute('data-id');
            document.getElementById('modalBookingCustomerName').value = button.getAttribute('data-name');
        });
    }

    var finishModal = document.getElementById('finishModal');
    if (finishModal) {
        finishModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('finishApptId').value = button.getAttribute('data-id');
            document.getElementById('finishCustomerName').innerText = button.getAttribute('data-name');
        });
    }

    function toggleOrderForm(isBuy) {
        var orderBlock = document.getElementById('orderInfoBlock');
        var rejectBlock = document.getElementById('rejectionInfoBlock');
        if (isBuy) {
            orderBlock.style.display = 'block';
            rejectBlock.style.display = 'none';
            document.getElementById('serviceSelect').required = true;
            document.getElementById('finalPrice').required = true;
        } else {
            orderBlock.style.display = 'none';
            rejectBlock.style.display = 'block';
            document.getElementById('serviceSelect').required = false;
            document.getElementById('finalPrice').required = false;
        }
    }

    function updatePrice() {
        var select = document.getElementById('serviceSelect');
        var originalInput = document.getElementById('originalPrice');
        
        var selectedOption = select.options[select.selectedIndex];
        var price = selectedOption.getAttribute('data-price');
        
        if (price) {
            originalInput.value = price;
            document.getElementById('discountInput').value = 0;
            calculateFinal();
        } else {
            originalInput.value = 0;
            calculateFinal();
        }
    }

    function calculateFinal() {
        var original = parseFloat(document.getElementById('originalPrice').value) || 0;
        var discount = parseFloat(document.getElementById('discountInput').value) || 0;
        var final = original - discount;
        if (final < 0) final = 0;
        document.getElementById('finalPrice').value = final;
    }
</script>
</body>
</html>