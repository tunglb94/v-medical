{% extends 'base.html' %}
{% load static %}

{% block title %}Lễ Tân Dashboard{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    .card-box { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
    .fc-event-main-frame { cursor: pointer; }
    #calendar { min-height: 650px; }
    .fc-toolbar-title { font-size: 1.2rem !important; text-transform: uppercase; }
    .appointment-list-item:hover { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold m-0"><i class="bi bi-calendar-check-fill me-2 text-primary"></i>QUẢN LÝ TIẾP ĐÓN</h4>
    <div>
        <button class="btn btn-primary btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#searchCustomerModal">
            <i class="bi bi-search me-1"></i> TRA CỨU
        </button>
        <button class="btn btn-success btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#walkinModal">
            <i class="bi bi-person-plus-fill me-1"></i> KHÁCH VÃNG LAI
        </button>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-3 d-flex flex-column" style="height: calc(100vh - 140px);">
        <div class="card card-box flex-grow-1 overflow-hidden d-flex flex-column">
            <div class="card-header bg-white py-2">
                <form method="GET" class="d-flex align-items-center">
                    <input type="date" name="date" class="form-control form-control-sm" value="{{ current_date|date:'Y-m-d' }}" onchange="this.form.submit()">
                </form>
            </div>
            <div class="card-body p-0 flex-grow-1 overflow-auto">
                <div class="list-group list-group-flush">
                    {% for appointment in appointments %}
                    <a href="javascript:void(0);" 
                       class="list-group-item list-group-item-action py-3 appointment-list-item" 
                       data-id="{{ appointment.id }}"
                       data-customer-name="{{ appointment.customer.name }}"
                       data-customer-phone="{{ appointment.customer.phone }}"
                       data-time="{{ appointment.appointment_date|date:'H:i d/m/Y' }}"
                       data-status="{{ appointment.get_status_display }}"
                       data-status-code="{{ appointment.status }}"
                       data-customer-code="{{ appointment.customer.customer_code|default:'' }}">
                        
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold text-truncate" style="max-width: 140px;">{{ appointment.customer.name }}</h6>
                            <span class="badge rounded-pill bg-{{ appointment.get_status_color }}" style="font-size: 0.7rem;">{{ appointment.get_status_display }}</span>
                        </div>
                        <small class="text-muted d-block"><i class="bi bi-clock me-1"></i>{{ appointment.appointment_date|date:"H:i" }} - {{ appointment.customer.phone }}</small>
                    </a>
                    {% empty %}
                    <div class="text-center p-4 text-muted small">Không có lịch hẹn.</div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer bg-light text-center small py-1">
                SL: <b>{{ appointments.count }}</b>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="card card-box h-100 p-2">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="appointmentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title fw-bold">CHI TIẾT LỊCH HẸN</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h4 class="fw-bold m-0" id="customerNameDetail"></h4>
                    <div class="text-muted" id="customerPhoneDetail"></div>
                </div>
                
                <div class="row text-center mb-3 g-2">
                    <div class="col-6"><div class="border p-2 rounded bg-light"><small>Giờ hẹn</small><div class="fw-bold text-primary" id="appointmentTimeDetail"></div></div></div>
                    <div class="col-6"><div class="border p-2 rounded bg-light"><small>Trạng thái</small><div id="appointmentStatusDetail" class="fw-bold"></div></div></div>
                </div>

                <div class="alert alert-light border d-flex justify-content-between align-items-center p-2 mb-3">
                    <span class="small fw-bold text-muted">Mã Khách Hàng:</span>
                    <span class="fw-bold text-danger fs-5" id="customerCodeDisplay"></span>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success fw-bold" id="btnOpenCheckin"><i class="bi bi-box-arrow-in-right me-2"></i>CHECK-IN (Đón khách)</button>
                    <button class="btn btn-warning fw-bold" id="btnOpenFinish"><i class="bi bi-cash-stack me-2"></i>THANH TOÁN / CHỐT DỊCH VỤ</button>
                    <button class="btn btn-outline-danger btn-sm cancel-btn">Hủy lịch hẹn</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title fw-bold">XÁC NHẬN ĐÓN KHÁCH</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="checkinForm">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Khách hàng: <strong id="checkinCustomerName"></strong></p>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Cập nhật Mã Khách hàng (Nếu cần)</label>
                        <input type="text" name="customer_code" class="form-control" id="customerCodeInput" placeholder="VD: KH001">
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="submit" class="btn btn-success fw-bold w-100">XÁC NHẬN</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="finishAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark py-2">
                <h6 class="modal-title fw-bold">CHỐT ĐƠN & THANH TOÁN</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'finish_appointment' %}" id="finishForm">
                {% csrf_token %}
                <input type="hidden" name="appointment_id" id="finishApptId">
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="small fw-bold">Bác sĩ</label>
                            <select name="doctor_id" class="form-select form-select-sm">
                                <option value="">-- Chọn --</option>
                                {% for doc in doctors %}<option value="{{ doc.id }}">{{ doc.last_name }} {{ doc.first_name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Kỹ thuật viên</label>
                            <select name="technician_id" class="form-select form-select-sm">
                                <option value="">-- Chọn --</option>
                                {% for tech in technicians %}<option value="{{ tech.id }}">{{ tech.last_name }} {{ tech.first_name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Sale Tư vấn</label>
                            <select name="consultant_id" class="form-select form-select-sm">
                                <option value="">-- Chọn --</option>
                                {% for cons in consultants %}<option value="{{ cons.id }}">{{ cons.last_name }} {{ cons.first_name }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-2">
                        <label class="small fw-bold">Kết quả:</label>
                        <select name="result_status" id="resultStatus" class="form-select form-select-sm" onchange="toggleOrderFields()">
                            <option value="buy">Khách MUA (Chốt đơn)</option>
                            <option value="reject">Khách TỪ CHỐI</option>
                        </select>
                    </div>

                    <div id="orderFields">
                        <div class="mb-2">
                            <label class="small fw-bold">Dịch vụ:</label>
                            <select name="service_id" id="serviceIdSelect" class="form-select form-select-sm">
                                <option value="">-- Chọn dịch vụ --</option>
                                {% for service in services %}<option value="{{ service.id }}" data-price="{{ service.base_price }}">{{ service.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="row g-2">
                            <div class="col-4"><label class="small">Giá gốc</label><input type="number" name="original_price" id="originalPrice" class="form-control form-control-sm" readonly></div>
                            <div class="col-4"><label class="small fw-bold">Tổng tiền</label><input type="number" name="total_amount" id="finalTotalAmount" class="form-control form-control-sm fw-bold text-primary" oninput="copyToActualRevenue()"></div>
                            <div class="col-4"><label class="small fw-bold text-success">Thực thu</label><input type="number" name="actual_revenue" id="actualRevenue" class="form-control form-control-sm fw-bold text-success"></div>
                        </div>
                    </div>

                    <div id="rejectFields" style="display:none;">
                        <textarea name="rejection_reason" class="form-control" placeholder="Nhập lý do khách không mua..."></textarea>
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="submit" class="btn btn-warning fw-bold w-100">HOÀN TẤT</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/vi.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- PHẦN QUAN TRỌNG SỬA LỖI URL ---
        // Django sẽ render URL này thành chuỗi, ví dụ: /bookings/check-in/0/
        // Ta dùng số 0 làm placeholder để replace bằng ID thật trong JS
        const CHECKIN_URL_TEMPLATE = "{% url 'checkin_appointment' 0 %}"; 
        
        // Hàm mở Modal Chi tiết
        window.openAppointmentModal = function(data) {
            // Fill dữ liệu text
            $('#customerNameDetail').text(data.customerName);
            $('#customerPhoneDetail').text(data.customerPhone);
            $('#appointmentTimeDetail').text(data.apptTime);
            $('#customerCodeDisplay').text(data.customerCode || '---');
            $('#appointmentStatusDetail').text(data.status);
            
            // Fill dữ liệu Form Check-in & Finish
            $('#checkinCustomerName').text(data.customerName);
            $('#customerCodeInput').val(data.customerCode);
            $('#finishApptId').val(data.id);
            
            // Xử lý Dynamic URL cho Form Check-in
            // Thay thế số 0 (hoặc ký tự placeholder) bằng ID thật
            const finalUrl = CHECKIN_URL_TEMPLATE.replace('0', data.id);
            $('#checkinForm').attr('action', finalUrl);

            // Điều khiển ẩn hiện nút
            if (data.statusCode === 'SCHEDULED') {
                $('#btnOpenCheckin').show();
                $('#btnOpenFinish').hide();
            } else if (data.statusCode === 'ARRIVED' || data.statusCode === 'IN_CONSULTATION') {
                $('#btnOpenCheckin').hide();
                $('#btnOpenFinish').show();
            } else {
                $('#btnOpenCheckin').hide();
                $('#btnOpenFinish').hide();
            }
            
            $('#appointmentDetailModal').modal('show');
        };

        // Chuyển Modal
        $('#btnOpenCheckin').click(function() {
            $('#appointmentDetailModal').modal('hide');
            setTimeout(() => $('#checkinModal').modal('show'), 200);
        });
        $('#btnOpenFinish').click(function() {
            $('#appointmentDetailModal').modal('hide');
            setTimeout(() => $('#finishAppointmentModal').modal('show'), 200);
        });

        // FullCalendar Init
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            events: '{% url "get_appointments_api" %}', // Đảm bảo URL này cũng đúng
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
            eventClick: function(info) {
                const p = info.event.extendedProps;
                openAppointmentModal({
                    id: info.event.id,
                    customerName: p.customerName,
                    customerPhone: p.phone,
                    apptTime: info.event.start.toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'}),
                    status: p.status,
                    statusCode: p.statusCode,
                    customerCode: p.customerCode
                });
            }
        });
        calendar.render();
        
        // List Click
        $('.appointment-list-item').click(function() {
            openAppointmentModal($(this).data());
        });

        // Logic tính tiền
        $('#serviceIdSelect').change(function() {
            const price = $(this).find(':selected').data('price');
            if(price) {
                $('#originalPrice').val(price);
                $('#finalTotalAmount').val(price);
                $('#actualRevenue').val(price);
            }
        });
    });

    function toggleOrderFields() {
        const status = document.getElementById('resultStatus').value;
        document.getElementById('orderFields').style.display = (status === 'buy') ? 'block' : 'none';
        document.getElementById('rejectFields').style.display = (status === 'buy') ? 'none' : 'block';
    }
    
    function copyToActualRevenue() {
        document.getElementById('actualRevenue').value = document.getElementById('finalTotalAmount').value;
    }
</script>
{% endblock %}