{% extends 'base.html' %}
{% load static %}

{% block title %}Lễ Tân Dashboard{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    .card-box { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
    .fc-event-main-frame { cursor: pointer; }
    .fc-event-main-frame:hover { opacity: 0.9; }
    
    /* Đảm bảo lịch có chiều cao hiển thị */
    #calendar {
        min-height: 600px;
    }
    .fc-toolbar-title { font-size: 1.25rem !important; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold m-0"><i class="bi bi-calendar-check-fill me-2 text-primary"></i>QUẢN LÝ LỊCH HẸN & TIẾP ĐÓN</h4>
    <div>
        <button class="btn btn-primary btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#searchCustomerModal">
            <i class="bi bi-search me-1"></i> TRA CỨU KHÁCH
        </button>
        <button class="btn btn-success btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#walkinModal">
            <i class="bi bi-person-plus-fill me-1"></i> KHÁCH VÃNG LAI
        </button>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-4 d-flex flex-column" style="height: calc(100vh - 140px);">
        <div class="card card-box flex-grow-1 overflow-hidden d-flex flex-column">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <span class="m-0 fw-bold text-uppercase text-muted small">Danh sách ngày: {{ current_date|date:"d/m/Y" }}</span>
                <form method="GET" class="d-flex" style="max-width: 130px;">
                    <input type="date" name="date" class="form-control form-control-sm" value="{{ current_date|date:'Y-m-d' }}" onchange="this.form.submit()">
                </form>
            </div>
            <div class="card-body p-0 flex-grow-1 overflow-auto">
                <div class="list-group list-group-flush">
                    {% for appointment in appointments %}
                    <a href="javascript:void(0);" 
                       class="list-group-item list-group-item-action py-3 appointment-list-item border-bottom" 
                       data-id="{{ appointment.id }}"
                       data-customer-name="{{ appointment.customer.name }}"
                       data-customer-phone="{{ appointment.customer.phone }}"
                       data-time="{{ appointment.appointment_date|date:'H:i d/m/Y' }}"
                       data-status="{{ appointment.get_status_display }}"
                       data-status-code="{{ appointment.status }}"
                       data-customer-code="{{ appointment.customer.customer_code|default:'' }}">
                        
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold text-dark">{{ appointment.customer.name }}</h6>
                            <span class="badge rounded-pill bg-{{ appointment.get_status_color }}">{{ appointment.get_status_display }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-end">
                            <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ appointment.appointment_date|date:"H:i" }} | {{ appointment.customer.phone }}</small>
                            {% if appointment.status == 'SCHEDULED' %}
                                <span class="text-primary small fw-bold">Check-in ngay &rarr;</span>
                            {% endif %}
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center p-5 text-muted small">
                        <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                        Chưa có lịch hẹn nào.
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer bg-light text-muted small text-center">
                Tổng cộng: <b>{{ appointments.count }}</b> khách
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card card-box h-100 p-3">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="appointmentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">CHI TIẾT LỊCH HẸN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h4 class="fw-bold mb-1" id="customerNameDetail"></h4>
                    <span class="text-muted" id="customerPhoneDetail"></span>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded text-center">
                            <small class="text-muted d-block mb-1">Thời gian hẹn</small>
                            <span class="fw-bold text-primary" id="appointmentTimeDetail"></span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded text-center">
                            <small class="text-muted d-block mb-1">Trạng thái</small>
                            <span id="appointmentStatusDetail" class="badge"></span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-qr-code me-2 fs-4"></i>
                    <div>
                        Mã Khách hàng: <strong id="customerCodeDisplay">---</strong>
                    </div>
                </div>

                <hr>

                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg fw-bold" id="btnOpenCheckin">
                        <i class="bi bi-box-arrow-in-right me-2"></i> CHECK-IN (Đón khách)
                    </button>
                    
                    <button class="btn btn-warning btn-lg fw-bold text-dark" id="btnOpenFinish">
                        <i class="bi bi-cash-stack me-2"></i> THANH TOÁN / CHỐT DỊCH VỤ
                    </button>
                    
                    <button class="btn btn-outline-danger btn-sm mt-2 cancel-btn" data-status="CANCELLED">
                        <i class="bi bi-x-circle me-1"></i> Hủy lịch hẹn này
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">CHECK-IN KHÁCH HÀNG</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="checkinForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle-fill me-1"></i>
                        Xác nhận khách hàng <strong><span id="checkinCustomerName"></span></strong> đã đến phòng khám?
                    </div>
                    <div class="mb-3">
                        <label for="customerCodeInput" class="form-label fw-bold">Nhập Mã Khách hàng (Nếu chưa có)</label>
                        <input type="text" name="customer_code" class="form-control form-control-lg text-uppercase" id="customerCodeInput" placeholder="VD: KH001">
                        <div class="form-text">Mã này sẽ được lưu cố định cho khách hàng.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success fw-bold">XÁC NHẬN CHECK-IN</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="finishAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">CHỐT ĐƠN & THANH TOÁN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="finishForm" action="{% url 'finish_appointment' %}">
                {% csrf_token %}
                <input type="hidden" name="appointment_id" id="finishApptId">
                <div class="modal-body">
                    <p class="fw-bold border-bottom pb-2">Khách hàng: <span id="finishCustomerName" class="text-primary fs-5"></span></p>

                    <h6 class="text-uppercase fw-bold text-muted small mt-3">1. Nhân sự thực hiện</h6>
                    <div class="row g-2 mb-3 bg-light p-3 rounded">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Bác sĩ</label>
                            <select name="doctor_id" class="form-select form-select-sm">
                                <option value="">-- Chọn Bác sĩ --</option>
                                {% for doc in doctors %}
                                    <option value="{{ doc.id }}">{{ doc.last_name }} {{ doc.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Kỹ thuật viên</label>
                            <select name="technician_id" class="form-select form-select-sm">
                                <option value="">-- Chọn KTV --</option>
                                {% for tech in technicians %}
                                    <option value="{{ tech.id }}">{{ tech.last_name }} {{ tech.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Sale Tư vấn</label>
                            <select name="consultant_id" class="form-select form-select-sm">
                                <option value="">-- Chọn TVV --</option>
                                {% for cons in consultants %}
                                    <option value="{{ cons.id }}">{{ cons.last_name }} {{ cons.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <h6 class="text-uppercase fw-bold text-muted small mt-3">2. Thông tin đơn hàng</h6>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Kết quả *</label>
                        <select name="result_status" id="resultStatus" class="form-select" onchange="toggleOrderFields()">
                            <option value="buy">Khách MUA Dịch vụ (Chốt đơn)</option>
                            <option value="reject">Khách KHÔNG MUA (Thất bại)</option>
                        </select>
                    </div>

                    <div id="orderFields">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Dịch vụ sử dụng</label>
                            <select name="service_id" id="serviceIdSelect" class="form-select">
                                <option value="">-- Chọn dịch vụ --</option>
                                {% for service in services %}
                                    <option value="{{ service.id }}" data-price="{{ service.base_price }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row g-2">
                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold">Giá niêm yết</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="original_price" id="originalPrice" class="form-control" value="0" readonly>
                                    <span class="input-group-text">đ</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-primary">Tổng sau giảm giá *</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="total_amount" id="finalTotalAmount" class="form-control fw-bold text-primary" required oninput="copyToActualRevenue()">
                                    <span class="input-group-text">đ</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-success">Khách thực trả *</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="actual_revenue" id="actualRevenue" class="form-control fw-bold text-success" required>
                                    <span class="input-group-text">đ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="rejectFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-danger">Lý do từ chối</label>
                            <textarea name="rejection_reason" class="form-control" rows="3" placeholder="Ghi rõ lý do khách không hài lòng..."></textarea>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning fw-bold w-100">HOÀN TẤT & LƯU</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/vi.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // Hàm mở Modal và xử lý Logic nút bấm
        window.openAppointmentModal = function(data) {
            // 1. Điền thông tin hiển thị
            $('#customerNameDetail').text(data.customerName);
            $('#customerPhoneDetail').text(data.customerPhone);
            $('#appointmentTimeDetail').text(data.apptTime);
            $('#customerCodeDisplay').text(data.customerCode ? data.customerCode : 'Chưa cập nhật');
            $('#appointmentStatusDetail').text(data.status).removeClass().addClass('badge rounded-pill bg-' + getStatusColor(data.statusCode));

            // 2. Xử lý URL Form Check-in (SỬA LỖI QUAN TRỌNG)
            // Ta dùng 1 URL mẫu có ID=0, sau đó replace bằng ID thật
            var checkinUrlTemplate = "{% url 'checkin_appointment' 0 %}"; 
            var finalCheckinUrl = checkinUrlTemplate.replace('0', data.id);
            $('#checkinForm').attr('action', finalCheckinUrl);

            // 3. Xử lý Form Chốt đơn
            $('#finishApptId').val(data.id);
            $('#checkinCustomerName').text(data.customerName);
            $('#finishCustomerName').text(data.customerName);
            $('#customerCodeInput').val(data.customerCode);

            // 4. Logic Ẩn/Hiện nút Check-in vs Chốt đơn
            if (data.statusCode === 'SCHEDULED') {
                $('#btnOpenCheckin').show();
                $('#btnOpenFinish').hide();
            } else if (data.statusCode === 'ARRIVED' || data.statusCode === 'IN_CONSULTATION') {
                $('#btnOpenCheckin').hide();
                $('#btnOpenFinish').show();
            } else {
                // Đã xong hoặc Hủy -> Ẩn hết
                $('#btnOpenCheckin').hide();
                $('#btnOpenFinish').hide();
            }

            // Xử lý nút Hủy
            if (data.statusCode === 'CANCELLED' || data.statusCode === 'COMPLETED') {
                $('.cancel-btn').hide();
            } else {
                $('.cancel-btn').show().data('id', data.id);
            }

            // Mở Modal
            $('#appointmentDetailModal').modal('show');
        };

        // --- SỰ KIỆN CHUYỂN MODAL ---
        $('#btnOpenCheckin').click(function() {
            $('#appointmentDetailModal').modal('hide');
            setTimeout(() => { $('#checkinModal').modal('show'); }, 200);
        });

        $('#btnOpenFinish').click(function() {
            $('#appointmentDetailModal').modal('hide');
            setTimeout(() => { $('#finishAppointmentModal').modal('show'); }, 200);
        });

        // --- KHỞI TẠO FULLCALENDAR ---
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', // Mặc định xem theo Tháng
            locale: 'vi',
            height: '100%',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hôm nay',
                month: 'Tháng',
                week: 'Tuần',
                day: 'Ngày'
            },
            events: '{% url "get_appointments_api" %}', // URL API lấy dữ liệu
            eventTimeFormat: {
                hour: '2-digit', minute: '2-digit', hour12: false
            },
            eventClick: function(info) {
                const props = info.event.extendedProps;
                const data = {
                    id: info.event.id,
                    customerName: props.customerName,
                    customerPhone: props.phone,
                    apptTime: info.event.start.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) + ' ' + info.event.start.toLocaleDateString('vi-VN'),
                    status: props.status,
                    statusCode: props.statusCode,
                    customerCode: props.customerCode
                };
                openAppointmentModal(data);
            }
        });
        calendar.render();

        // Xử lý click từ danh sách bên trái
        $('.appointment-list-item').click(function() {
            openAppointmentModal($(this).data());
        });
    });

    // Helper functions
    function getStatusColor(code) {
        if(code === 'SCHEDULED') return 'primary';
        if(code === 'ARRIVED') return 'warning text-dark';
        if(code === 'COMPLETED') return 'success';
        if(code === 'CANCELLED') return 'danger';
        return 'secondary';
    }

    function toggleOrderFields() {
        var status = document.getElementById('resultStatus').value;
        if (status === 'buy') {
            document.getElementById('orderFields').style.display = 'block';
            document.getElementById('rejectFields').style.display = 'none';
        } else {
            document.getElementById('orderFields').style.display = 'none';
            document.getElementById('rejectFields').style.display = 'block';
        }
    }

    function copyToActualRevenue() {
        var total = document.getElementById('finalTotalAmount').value;
        document.getElementById('actualRevenue').value = total;
    }

    // Auto-fill giá tiền khi chọn dịch vụ
    document.getElementById('serviceIdSelect').addEventListener('change', function() {
        var price = this.options[this.selectedIndex].getAttribute('data-price');
        if(price) {
            document.getElementById('originalPrice').value = price;
            document.getElementById('finalTotalAmount').value = price;
            document.getElementById('actualRevenue').value = price;
        }
    });
</script>
{% endblock %}