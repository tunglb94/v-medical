{% extends 'base.html' %}
{% load static %}

{% block title %}Lễ Tân Dashboard{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    .card-box { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
    .fc-event-main-frame { cursor: pointer; }
    .fc-event-main-frame:hover { opacity: 0.9; }
    .birth-icon { font-size: 1.5rem; color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold m-0"><i class="bi bi-calendar-check-fill me-2 text-primary"></i>LỊCH HẸN HÔM NAY</h4>
    <div>
        <button class="btn btn-primary btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#searchCustomerModal"><i class="bi bi-search me-1"></i> TRA CỨU KHÁCH</button>
        <button class="btn btn-success btn-sm fw-bold ms-2" data-bs-toggle="modal" data-bs-target="#walkinModal"><i class="bi bi-person-plus-fill me-1"></i> KHÁCH VÃNG LAI</button>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-5 d-flex flex-column" style="height: calc(100vh - 140px);">
        <div class="card card-box flex-grow-1 overflow-hidden d-flex flex-column">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span class="m-0 fw-bold">Lịch hẹn: {{ current_date|date:"d/m/Y" }}</span>
                <form method="GET" class="d-flex">
                    <input type="date" name="date" class="form-control form-control-sm me-2" value="{{ current_date|date:'Y-m-d' }}" onchange="this.form.submit()">
                </form>
            </div>
            <div class="card-body p-0 flex-grow-1 overflow-auto">
                <div class="list-group list-group-flush">
                    {% for appointment in appointments %}
                    <a href="javascript:void(0);" class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center appointment-list-item" 
                       data-id="{{ appointment.id }}"
                       data-customer-name="{{ appointment.customer.name }}"
                       data-customer-phone="{{ appointment.customer.phone }}"
                       data-time="{{ appointment.appointment_date|date:'H:i d/m/Y' }}"
                       data-status="{{ appointment.get_status_display }}"
                       data-status-code="{{ appointment.status }}"
                       data-customer-code="{{ appointment.customer.customer_code|default:'' }}">
                        
                        <div class="d-flex align-items-center">
                            <span class="badge rounded-pill me-3" style="width: 50px;">
                                <div class="fw-bold fs-5">{{ appointment.appointment_date|date:"H:i" }}</div>
                            </span>
                            <div>
                                <div class="fw-bold text-truncate" style="max-width: 200px;">{{ appointment.customer.name }} ({{ appointment.customer.phone }})</div>
                                <small class="text-muted">
                                    {{ appointment.get_status_display }}
                                    {% if appointment.assigned_consultant %}| TVV: {{ appointment.assigned_consultant.last_name }}{% endif %}
                                    {% if appointment.assigned_doctor %}| BS: {{ appointment.assigned_doctor.last_name }}{% endif %}
                                </small>
                            </div>
                        </div>
                        <span class="badge rounded-pill bg-{{ appointment.get_status_color }}">{{ appointment.get_status_display }}</span>
                    </a>
                    {% empty %}
                    <div class="text-center p-5 text-muted small">Không có lịch hẹn nào.</div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer bg-light text-muted small text-center">
                Tổng cộng: {{ appointments.count }} lịch hẹn
            </div>
        </div>
    </div>

    <div class="col-lg-7 d-flex flex-column" style="height: calc(100vh - 140px);">
        <div class="row g-3 flex-grow-1">
            <div class="col-12 flex-grow-1">
                <div class="card card-box h-100 p-3">
                    <div id='calendar'></div>
                </div>
            </div>
            <div class="col-12">
                <div class="card card-box p-3 border-start border-4 border-warning">
                    <h6 class="fw-bold m-0 text-warning"><i class="bi bi-gift-fill me-2"></i>SINH NHẬT HÔM NAY</h6>
                    <div class="d-flex flex-wrap gap-3 mt-2">
                        {% for customer in birthdays_today %}
                            <div class="badge bg-warning text-dark p-2 fw-normal rounded-pill">
                                {{ customer.name }} ({{ customer.phone }})
                            </div>
                        {% empty %}
                            <p class="small text-muted mb-0">Hôm nay không có khách hàng nào sinh nhật.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="appointmentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">CHI TIẾT LỊCH HẸN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Khách hàng: <span id="customerNameDetail" class="fw-bold"></span> (<span id="customerPhoneDetail"></span>)</p>
                <p>Thời gian: <span id="appointmentTimeDetail" class="fw-bold text-primary"></span></p>
                <p>Trạng thái: <span id="appointmentStatusDetail" class="badge"></span></p>
                <p>Mã khách hàng: <span id="customerCodeDisplay" class="fw-bold text-info"></span></p>
                
                <hr>

                <div class="d-flex gap-2">
                    <button class="btn btn-success checkin-btn fw-bold" data-bs-toggle="modal" data-bs-target="#checkinModal">
                        <i class="bi bi-box-arrow-in-right"></i> CHECK-IN
                    </button>
                    <button class="btn btn-warning finish-btn fw-bold" data-bs-toggle="modal" data-bs-target="#finishAppointmentModal">
                        <i class="bi bi-cash-stack"></i> CHỐT ĐƠN/KẾT THÚC
                    </button>
                    <button class="btn btn-danger cancel-btn fw-bold" data-status="CANCELLED"><i class="bi bi-x-octagon"></i> HỦY</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">CHECK-IN KHÁCH HÀNG</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="checkinForm">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-danger fw-bold">Xác nhận Check-in cho khách hàng <span id="checkinCustomerName" class="text-primary"></span>?</p>
                    <div class="mb-3">
                        <label for="customerCodeInput" class="form-label">Mã Khách hàng (Nếu có)</label>
                        <input type="text" name="customer_code" class="form-control" id="customerCodeInput" placeholder="VD: VMC-XXXX">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success fw-bold"><i class="bi bi-box-arrow-in-right me-1"></i> CHECK-IN</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="finishAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">CHỐT ĐƠN / KẾT THÚC DỊCH VỤ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="finishForm" action="{% url 'finish_appointment' %}">
                {% csrf_token %}
                <input type="hidden" name="appointment_id" id="finishApptId">
                <div class="modal-body">
                    <p class="fw-bold">Chốt ca cho khách hàng: <span id="finishCustomerName" class="text-primary"></span></p>

                    <h6 class="mt-4 fw-bold">Phân công thực hiện:</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Bác sĩ</label>
                            <select name="doctor_id" class="form-select form-select-sm">
                                <option value="">-- Bỏ qua --</option>
                                {% for doc in doctors %}
                                    <option value="{{ doc.id }}">{{ doc.last_name }} {{ doc.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Kỹ thuật viên</label>
                            <select name="technician_id" class="form-select form-select-sm">
                                <option value="">-- Bỏ qua --</option>
                                {% for tech in technicians %}
                                    <option value="{{ tech.id }}">{{ tech.last_name }} {{ tech.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Tư vấn viên (Chốt Sale)</label>
                            <select name="consultant_id" class="form-select form-select-sm">
                                <option value="">-- Bỏ qua --</option>
                                {% for cons in consultants %}
                                    <option value="{{ cons.id }}">{{ cons.last_name }} {{ cons.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <h6 class="mt-4 fw-bold">Kết quả đơn hàng:</h6>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Kết quả cuối cùng *</label>
                        <select name="result_status" id="resultStatus" class="form-select" onchange="toggleOrderFields()">
                            <option value="buy">1. Khách mua/Chốt đơn</option>
                            <option value="reject">2. Khách từ chối/Không mua</option>
                        </select>
                    </div>

                    <div id="orderFields">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Dịch vụ mua</label>
                            <select name="service_id" id="serviceIdSelect" class="form-select">
                                <option value="">-- Chọn dịch vụ chính --</option>
                                {% for service in services %}
                                    <option value="{{ service.id }}" data-price="{{ service.base_price }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row g-2">
                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-muted">Giá gốc (VND)</label>
                                <input type="number" name="original_price" class="form-control form-control-sm" id="originalPrice" value="0" min="0" readonly>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-muted">Tổng đơn hàng * (VND)</label>
                                <input type="number" name="total_amount" class="form-control form-control-sm fw-bold text-primary" id="finalTotalAmount" required min="0" oninput="copyToActualRevenue()">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label small fw-bold text-muted">Thực thu * (VND)</label>
                                <input type="number" name="actual_revenue" class="form-control form-control-sm fw-bold text-success" id="actualRevenue" required min="0">
                                <div class="form-text small text-muted">Số tiền khách thanh toán thực tế.</div>
                            </div>
                        </div>
                        </div>

                    <div id="rejectFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Lý do từ chối/Không mua</label>
                            <textarea name="rejection_reason" class="form-control"></textarea>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning fw-bold"><i class="bi bi-send me-1"></i> HOÀN TẤT CHỐT CA</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="searchCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold">TRA CỨU KHÁCH HÀNG & LÊN LỊCH</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="GET" action="{% url 'reception_home' %}">
                    <div class="input-group mb-3">
                        <input type="text" name="q" class="form-control" placeholder="Tên hoặc SĐT khách hàng" value="{{ search_query }}">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </form>
                {% if search_results %}
                    <h6 class="fw-bold small">Kết quả tìm kiếm:</h6>
                    <div class="list-group">
                        {% for customer in search_results %}
                            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#scheduleModal" data-customer-id="{{ customer.id }}" data-customer-name="{{ customer.name }}">
                                <span>{{ customer.name }} ({{ customer.phone }})</span>
                                <i class="bi bi-calendar-plus"></i>
                            </a>
                        {% endfor %}
                    </div>
                {% elif search_query %}
                    <p class="small text-muted">Không tìm thấy khách hàng nào khớp với "{{ search_query }}".</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="walkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">TIẾP NHẬN KHÁCH VÃNG LAI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'add_walkin_appointment' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Tên khách *</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">SĐT *</label>
                        <input type="text" name="phone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Thời gian tiếp nhận</label>
                        <input type="datetime-local" name="appointment_date" class="form-control" value="{{ today|date:'Y-m-d' }}T{% now 'H:i' %}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success fw-bold"><i class="bi bi-person-check-fill me-1"></i> TIẾP NHẬN NGAY</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">LÊN LỊCH HẸN NHANH</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'create_appointment_reception' %}">
                {% csrf_token %}
                <input type="hidden" name="customer_id" id="scheduleCustomerId">
                <div class="modal-body">
                    <p>Khách hàng: <span id="scheduleCustomerName" class="fw-bold text-primary"></span></p>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Thời gian hẹn *</label>
                        <input type="datetime-local" name="appointment_date" class="form-control" required value="{{ current_date|date:'Y-m-d' }}T14:00">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary fw-bold"><i class="bi bi-calendar-plus me-1"></i> LÊN LỊCH</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/vi.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // Hàm chung để mở Modal và điền dữ liệu (FIX BUG LOGIC)
        // Hàm này đảm bảo ID luôn được điền dù click từ Lịch hay từ Danh sách
        window.openAppointmentModal = function(data) {
            // Điền thông tin vào UI
            $('#customerNameDetail').text(data.customerName);
            $('#customerPhoneDetail').text(data.customerPhone);
            $('#appointmentTimeDetail').text(data.apptTime);
            $('#customerCodeDisplay').text(data.customerCode || 'Chưa có');
            $('#appointmentStatusDetail').text(data.status).removeClass().addClass('badge rounded-pill bg-' + getStatusColor(data.statusCode));

            // LOGIC QUAN TRỌNG: Cập nhật hidden ID và Form Action
            const baseUrl = '{% url "checkin" appointment_id=0 %}';
            $('#checkinForm').attr('action', baseUrl.replace('0', data.id));
            
            // Cập nhật ID cho form Chốt đơn (Lỗi "Không tìm thấy ID" là do thiếu dòng này khi click danh sách)
            $('#finishApptId').val(data.id);
            $('#finishForm').attr('action', '{% url "finish_appointment" %}');

            // Điền tên khách vào các form con
            $('#checkinCustomerName').text(data.customerName);
            $('#finishCustomerName').text(data.customerName);
            $('#customerCodeInput').val(data.customerCode);

            // Ẩn hiện nút bấm
            $('.checkin-btn').toggle(data.statusCode === 'SCHEDULED');
            $('.finish-btn').toggle(data.statusCode === 'ARRIVED');
            $('.cancel-btn').toggle(data.statusCode !== 'CANCELLED' && data.statusCode !== 'COMPLETED');
            $('.cancel-btn').data('id', data.id);

            // Mở Modal
            $('#appointmentDetailModal').modal('show');
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '{% url "get_appointments_api" %}',
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            eventClick: function(info) {
                // Click từ Calendar
                const data = {
                    id: info.event.id,
                    customerName: info.event.extendedProps.customerName,
                    customerPhone: info.event.extendedProps.phone,
                    apptTime: info.event.start.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + ' ' + info.event.start.toLocaleDateString('vi-VN'),
                    status: info.event.extendedProps.status,
                    statusCode: info.event.extendedProps.statusCode,
                    customerCode: info.event.extendedProps.customerCode
                };
                openAppointmentModal(data);
            }
        });
        calendar.render();

        // Click từ Danh sách (Sidebar) - FIX LOGIC
        // Sử dụng event delegation để bắt sự kiện click cho class .appointment-list-item
        $(document).on('click', '.appointment-list-item', function() {
            const data = {
                id: $(this).data('id'),
                customerName: $(this).data('customer-name'),
                customerPhone: $(this).data('customer-phone'),
                apptTime: $(this).data('time'),
                status: $(this).data('status'),
                statusCode: $(this).data('status-code'),
                customerCode: $(this).data('customer-code')
            };
            openAppointmentModal(data);
        });

        // Xử lý khi modal chi tiết được đóng
        $('#appointmentDetailModal').on('hidden.bs.modal', function () {
            if ($('#checkinModal').hasClass('show') || $('#finishAppointmentModal').hasClass('show')) {
                $('body').addClass('modal-open');
                $('.modal-backdrop').first().css('z-index', 1040);
            }
        });
    });

    function getStatusColor(statusCode) {
        switch (statusCode) {
            case 'SCHEDULED': return 'primary';
            case 'ARRIVED': return 'warning';
            case 'COMPLETED': return 'success';
            case 'CANCELLED': 
            case 'NO_SHOW': return 'danger';
            default: return 'secondary';
        }
    }
    
    function copyToActualRevenue() {
        var totalAmount = document.getElementById('finalTotalAmount').value;
        var actualRevenue = document.getElementById('actualRevenue');
        actualRevenue.value = totalAmount;
    }

    function toggleOrderFields() {
        var status = document.getElementById('resultStatus').value;
        if (status === 'buy') {
            document.getElementById('orderFields').style.display = 'block';
            document.getElementById('rejectFields').style.display = 'none';
        } else {
            document.getElementById('orderFields').style.display = 'none';
            document.getElementById('rejectFields').style.display = 'block';
        }
    }
    
    $('#scheduleModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var customerId = button.data('customer-id');
        var customerName = button.data('customer-name');
        
        var modal = $(this);
        modal.find('#scheduleCustomerId').val(customerId);
        modal.find('#scheduleCustomerName').text(customerName);
    });

    $('.cancel-btn').on('click', function() {
        if (confirm('Bạn có chắc chắn muốn HỦY lịch hẹn này không?')) {
            const apptId = $(this).data('id');
            const form = $('<form action="{% url "reception_home" %}" method="POST" style="display:none;"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="appointment_id" value="' + apptId + '">');
            form.append('<input type="hidden" name="new_status" value="CANCELLED">');
            $('body').append(form);
            form.submit();
        }
    });

    document.getElementById('serviceIdSelect').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const basePrice = selectedOption.getAttribute('data-price');
        document.getElementById('originalPrice').value = basePrice || 0;
    });
</script>
{% endblock %}