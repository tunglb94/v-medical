{% extends 'base.html' %}
{% load static %}

{% block title %}Telesale Dashboard - V-Medical{% endblock %}

{% block extra_css %}
<style>
    .list-group-item.active { background-color: #eef2ff; color: #000; border-left: 4px solid #3498db; border-color: #f0f0f0; }
    .timeline-item { border-left: 2px solid #dee2e6; padding-left: 15px; padding-bottom: 15px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #bdc3c7; }
    .timeline-item.success::before { background: #198754; }
    .form-control:read-only { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="row g-3 h-100">
    <div class="col-12 col-lg-3 d-flex flex-column" style="height: calc(100vh - 40px);">
        <div class="card card-box h-100 d-flex flex-column overflow-hidden">
            <div class="p-3 border-bottom bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold text-primary mb-0"><i class="bi bi-list-ul me-2"></i>DANH SÁCH</h6>
                    <button type="button" class="btn btn-sm btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="bi bi-plus-lg"></i></button>
                </div>

                <form method="GET" id="filterForm">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" name="q" class="form-control" placeholder="Tìm SĐT, Tên..." value="{{ search_query }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                    
                    <div class="btn-group w-100 mb-1" role="group">
                        <input type="radio" class="btn-check" name="type" id="btnNew" value="new" {% if filter_type == 'new' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-success btn-sm" for="btnNew">Mới</label>

                        <input type="radio" class="btn-check" name="type" id="btnOld" value="old" {% if filter_type == 'old' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-secondary btn-sm" for="btnOld">Cũ</label>
                        
                        <input type="radio" class="btn-check" name="type" id="btnCallback" value="callback" {% if filter_type == 'callback' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-warning text-dark btn-sm" for="btnCallback">Gọi lại</label>
                    </div>
                    
                    <div class="d-flex gap-1">
                        <button type="submit" name="type" value="birthday" class="btn btn-sm {% if filter_type == 'birthday' %}btn-danger{% else %}btn-outline-danger{% endif %} flex-fill" title="Sinh nhật">
                            <i class="bi bi-cake2-fill"></i> SN
                        </button>
                        <button type="submit" name="type" value="dormant" class="btn btn-sm {% if filter_type == 'dormant' %}btn-dark{% else %}btn-outline-dark{% endif %} flex-fill" title="Ngủ đông">
                            <i class="bi bi-moon-stars-fill"></i> Ngủ
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="list-group list-group-flush overflow-auto flex-grow-1">
                {% for customer in customers %}
                    <a href="?id={{ customer.id }}&type={{ filter_type }}&q={{ search_query }}" 
                       class="list-group-item list-group-item-action {% if selected_customer.id == customer.id %}active{% endif %} py-3">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <div class="fw-bold text-truncate" style="max-width: 140px;">
                                {{ customer.name }}
                                {% if customer.ranking == 'DIAMOND' %}<i class="bi bi-gem text-info ms-1 small"></i>{% endif %}
                                {% if customer.ranking == 'GOLD' %}<i class="bi bi-star-fill text-warning ms-1 small"></i>{% endif %}
                            </div>
                            <span class="badge bg-light text-secondary border fw-normal">{{ customer.created_at|date:"d/m" }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center small text-muted">
                            <span>{{ customer.phone }}</span>
                            {% if customer.source == 'FACEBOOK' %}<i class="bi bi-facebook text-primary"></i>{% endif %}
                        </div>
                    </a>
                {% empty %}
                    <div class="text-center p-4 text-muted small">Không có dữ liệu</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-9 d-flex flex-column" style="height: calc(100vh - 40px);">
        <div class="card card-box h-100 overflow-hidden">
            {% if selected_customer %}
                <div class="p-4 border-bottom bg-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="fw-bold mb-1">
                                {{ selected_customer.name }}
                                {% if selected_customer.ranking == 'DIAMOND' %}<span class="badge bg-info ms-2 fs-6">DIAMOND</span>{% endif %}
                                {% if selected_customer.ranking == 'GOLD' %}<span class="badge bg-warning text-dark ms-2 fs-6">GOLD</span>{% endif %}
                            </h4>
                            <div class="text-muted"><i class="bi bi-telephone me-2"></i>{{ selected_customer.phone }}</div>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark border mb-1">{{ selected_customer.get_source_display }}</div>
                            <div class="fw-bold text-danger">{{ selected_customer.get_skin_condition_display }}</div>
                        </div>
                    </div>
                    <div class="row g-2 mt-3 small text-muted">
                        <div class="col-auto border-end pe-3">Tuổi: <strong>{{ selected_customer.age|default:'--' }}</strong></div>
                        <div class="col-auto border-end pe-3">Tỉnh: <strong>{{ selected_customer.city|default:'--' }}</strong></div>
                        <div class="col-auto">Note Data: {{ selected_customer.note_telesale }}</div>
                    </div>
                </div>

                <div class="d-flex flex-grow-1 overflow-hidden">
                    <div class="w-50 border-end p-4 overflow-auto bg-light">
                        <h6 class="fw-bold text-secondary mb-3 small">LỊCH SỬ TƯƠNG TÁC</h6>
                        {% for log in call_history %}
                            <div class="timeline-item {% if log.status == 'BOOKED' %}success{% endif %}">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold small">{{ log.caller.username|default:"Hệ thống" }}</span>
                                    <small class="text-muted" style="font-size: 0.75rem;">{{ log.call_time|date:"d/m H:i" }}</small>
                                </div>
                                <span class="badge rounded-pill border bg-white text-dark mb-1">{{ log.get_status_display }}</span>
                                <p class="mb-0 small text-secondary fst-italic bg-white p-2 rounded border">{{ log.note }}</p>
                            </div>
                        {% empty %}
                            <p class="text-muted small text-center">Chưa có lịch sử.</p>
                        {% endfor %}
                    </div>

                    <div class="w-50 p-4 d-flex flex-column bg-white">
                        <h6 class="fw-bold text-primary mb-3 small">CẬP NHẬT CUỘC GỌI</h6>
                        <form method="POST" class="d-flex flex-column flex-grow-1">
                            {% csrf_token %}
                            <div class="mb-3 flex-grow-1">
                                <textarea name="note" class="form-control h-100 p-3" placeholder="Nội dung cuộc gọi..." style="resize: none; background:#f8f9fa;" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small mb-1">Hẹn lịch (Nếu có):</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-calendar-event"></i></span>
                                    <input type="datetime-local" name="appointment_date" class="form-control">
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" name="status" value="BOOKED" class="btn btn-success fw-bold"><i class="bi bi-calendar-check me-2"></i>CHỐT LỊCH HẸN</button>
                                <div class="row g-2">
                                    <div class="col-6"><button type="submit" name="status" value="CALLING" class="btn btn-warning w-100 fw-bold">Gọi lại sau</button></div>
                                    <div class="col-6"><button type="submit" name="status" value="NO_ANSWER" class="btn btn-light border w-100">Ko nghe máy</button></div>
                                </div>
                                <button type="submit" name="status" value="NOT_INTERESTED" class="btn btn-outline-danger btn-sm border-0">Khách từ chối / Sai số</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted bg-light">
                    <div class="text-center">
                        <i class="bi bi-arrow-left-circle display-4 mb-3 opacity-25"></i>
                        <h5>Chọn khách hàng để làm việc</h5>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold">Thêm Khách Mới</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'add_customer' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body bg-light">
            <div class="row mb-3">
                <div class="col-md-6"><label class="form-label fw-bold">Họ Tên *</label><input type="text" name="name" class="form-control" required></div>
                <div class="col-md-6"><label class="form-label fw-bold">SĐT *</label><input type="text" name="phone" class="form-control" required></div>
            </div>
            <button type="submit" class="btn btn-primary fw-bold w-100">Lưu Hồ Sơ</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}