{% extends 'base.html' %}
{% load static %}

{% block title %}Telesale Dashboard - V-Medical{% endblock %}

{% block extra_css %}
<style>
    .list-group-item.active { background-color: #eef2ff; color: #000; border-left: 4px solid #3498db; border-color: #f0f0f0; }
    .timeline-item { border-left: 2px solid #dee2e6; padding-left: 15px; padding-bottom: 15px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #bdc3c7; }
    .timeline-item.success::before { background: #198754; }
    .sticky-bottom-action { position: sticky; bottom: 0; background: white; padding-top: 15px; padding-bottom: 5px; border-top: 1px solid #eee; z-index: 10; margin-top: auto; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold text-dark m-0">TELESALE CENTER</h4>
    <a href="{% url 'telesale_report' %}" class="btn btn-outline-primary fw-bold shadow-sm btn-sm">
        <i class="bi bi-bar-chart-line-fill me-2"></i>XEM B√ÅO C√ÅO
    </a>
</div>

<div class="row g-3" style="height: calc(100vh - 110px);">
    <div class="col-12 col-lg-3 d-flex flex-column h-100">
        <div class="card card-box h-100 d-flex flex-column overflow-hidden">
            <div class="p-3 border-bottom bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold text-primary mb-0">DANH S√ÅCH DATA</h6>
                    <button type="button" class="btn btn-sm btn-primary rounded-circle shadow-sm" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="bi bi-plus-lg"></i></button>
                </div>
                <form method="GET" id="filterForm">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" name="q" class="form-control" placeholder="SƒêT, T√™n..." value="{{ search_query }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                    <div class="btn-group w-100 mb-1" role="group">
                        <input type="radio" class="btn-check" name="type" id="btnNew" value="new" {% if filter_type == 'new' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-success btn-sm" for="btnNew">M·ªõi</label>
                        <input type="radio" class="btn-check" name="type" id="btnOld" value="old" {% if filter_type == 'old' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-secondary btn-sm" for="btnOld">C≈©</label>
                        <input type="radio" class="btn-check" name="type" id="btnCallback" value="callback" {% if filter_type == 'callback' %}checked{% endif %} onchange="this.form.submit()">
                        <label class="btn btn-outline-warning text-dark btn-sm" for="btnCallback">G·ªçi l·∫°i</label>
                    </div>
                </form>
            </div>
            
            <div class="list-group list-group-flush overflow-auto flex-grow-1">
                {% for customer in customers %}
                    <a href="?id={{ customer.id|stringformat:'d' }}&type={{ filter_type }}&q={{ search_query }}" 
                       class="list-group-item list-group-item-action {% if selected_customer.id == customer.id %}active{% endif %} py-3">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <div class="fw-bold text-truncate" style="max-width: 140px;">{{ customer.name }}</div>
                            <span class="badge bg-light text-secondary border fw-normal">{{ customer.created_at|date:"d/m" }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center small text-muted">
                            <span class="me-1">{{ customer.phone }}</span>
                            
                            <span class="badge bg-light text-dark border" title="Sale ph·ª• tr√°ch">
                                {% if customer.assigned_telesale %}
                                    <i class="bi bi-person-fill text-primary"></i> 
                                    {% if customer.assigned_telesale.last_name or customer.assigned_telesale.first_name %}
                                        {{ customer.assigned_telesale.last_name }} {{ customer.assigned_telesale.first_name }}
                                    {% else %}
                                        {{ customer.assigned_telesale.username }}
                                    {% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </span>
                        </div>
                    </a>
                {% empty %}
                    <div class="text-center p-4 text-muted small">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-9 d-flex flex-column h-100">
        <div class="card card-box h-100 overflow-hidden">
            {% if selected_customer %}
                <form method="POST" class="d-flex flex-column h-100">
                    {% csrf_token %}
                    <div class="p-3 border-bottom bg-white">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">H·ªç t√™n</label>
                                <input type="text" name="cus_name" class="form-control form-control-sm fw-bold text-primary" value="{{ selected_customer.name }}">
                            </div>
                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">SƒêT</label>
                                <input type="text" name="cus_phone" class="form-control form-control-sm fw-bold" value="{{ selected_customer.phone }}">
                            </div>
                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">Gi·ªõi t√≠nh</label>
                                <select name="cus_gender" class="form-select form-select-sm">
                                    {% for code, label in gender_choices %}
                                    <option value="{{ code }}" {% if selected_customer.gender == code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">Ng√†y sinh</label>
                                <input type="date" name="cus_dob" class="form-control form-control-sm" value="{{ selected_customer.dob|date:'Y-m-d' }}">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">Sale nh·∫≠n data</label>
                                <input type="text" class="form-control form-control-sm bg-light text-dark fw-bold" 
                                       value="{% if selected_customer.assigned_telesale.last_name or selected_customer.assigned_telesale.first_name %}{{ selected_customer.assigned_telesale.last_name }} {{ selected_customer.assigned_telesale.first_name }}{% else %}{{ selected_customer.assigned_telesale.username|default:'--' }}{% endif %}" readonly>
                            </div>

                            <div class="col-md-2">
                                <label class="small text-muted fw-bold">D·ªãch v·ª•</label>
                                <select name="cus_skin" class="form-select form-select-sm text-danger fw-bold">
                                    {% for code, label in skin_choices %}
                                    <option value="{{ code }}" {% if selected_customer.skin_condition == code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-12 mt-2">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light">ƒê/C</span>
                                    <input type="text" name="cus_city" class="form-control" style="max-width: 150px;" value="{{ selected_customer.city|default:'' }}" placeholder="T·ªânh/TP">
                                    <input type="text" name="cus_address" class="form-control" value="{{ selected_customer.address|default:'' }}" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-grow-1 overflow-hidden">
                        <div class="w-50 border-end p-3 overflow-auto bg-light">
                            <h6 class="fw-bold text-secondary mb-3 small"><i class="bi bi-clock-history me-1"></i>L·ªäCH S·ª¨ T∆Ø∆†NG T√ÅC</h6>
                            {% for log in call_history %}
                                <div class="timeline-item {% if log.status == 'BOOKED' %}success{% endif %}">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-bold small">
                                            {% if log.caller.last_name or log.caller.first_name %}
                                                {{ log.caller.last_name }} {{ log.caller.first_name }}
                                            {% else %}
                                                {{ log.caller.username }}
                                            {% endif %}
                                        </span>
                                        <small class="text-muted">{{ log.call_time|date:"d/m H:i" }}</small>
                                    </div>
                                    <span class="badge rounded-pill border bg-white text-dark mb-1">{{ log.get_status_display }}</span>
                                    <p class="mb-0 small text-secondary fst-italic bg-white p-2 rounded border">{{ log.note }}</p>
                                </div>
                            {% empty %}
                                <div class="text-center mt-5 text-muted small">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>
                            {% endfor %}
                            
                            {% if selected_customer.note_telesale %}
                                <div class="alert alert-warning small mt-3">
                                    <strong><i class="bi bi-sticky me-1"></i>Note Ngu·ªìn:</strong><br>
                                    {{ selected_customer.note_telesale }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="w-50 p-3 d-flex flex-column bg-white position-relative">
                            <h6 class="fw-bold text-primary mb-3 small"><i class="bi bi-headset me-1"></i>GHI NH·∫¨N K·∫æT QU·∫¢</h6>
                            <div class="flex-grow-1 mb-3">
                                <textarea name="note" class="form-control h-100 p-3 bg-light" placeholder="N·ªôi dung cu·ªôc g·ªçi..." style="resize: none;" required></textarea>
                            </div>
                            <div class="sticky-bottom-action">
                                <div class="mb-2">
                                    <select name="status" id="callStatusSelect" class="form-select form-select-lg fw-bold border-primary" onchange="toggleDateInput()">
                                        {% for code, label in status_choices %}
                                        <option value="{{ code }}" {% if code == 'NEW' %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="appointmentDateInput" class="mb-2" style="display: none;">
                                    <label class="small fw-bold text-success">üìÖ Ng√†y gi·ªù h·∫πn</label>
                                    <input type="datetime-local" name="appointment_date" class="form-control border-success fw-bold">
                                </div>
                                <button type="submit" class="btn btn-primary fw-bold w-100 py-3 shadow-sm text-uppercase">
                                    <i class="bi bi-save me-2"></i>L∆∞u & C·∫≠p nh·∫≠t
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted bg-light">
                    <div class="text-center">
                        <i class="bi bi-telephone-inbound display-1 mb-3 opacity-25"></i>
                        <h5>Ch·ªçn kh√°ch h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu g·ªçi</h5>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">TH√äM DATA M·ªöI</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form action="{% url 'add_customer' %}" method="POST">
          {% csrf_token %}
          <div class="modal-body bg-light">
            <div class="row mb-3"><div class="col-md-6"><label class="form-label fw-bold small">H·ªç T√™n *</label><input type="text" name="name" class="form-control" required></div><div class="col-md-6"><label class="form-label fw-bold small">SƒêT *</label><input type="text" name="phone" class="form-control" placeholder="V√≠ d·ª•: 0912345678" required></div></div>
            <div class="row mb-3"><div class="col-md-4"><label class="form-label fw-bold small">Gi·ªõi t√≠nh</label><select name="gender" class="form-select">{% for code, label in gender_choices %}<option value="{{ code }}">{{ label }}</option>{% endfor %}</select></div><div class="col-md-4"><label class="form-label fw-bold small">Ng√†y sinh</label><input type="date" name="dob" class="form-control"></div><div class="col-md-4"><label class="form-label fw-bold small">T·ªânh / Th√†nh</label><input class="form-control" name="city" list="cityOptions"></div></div>
            <div class="mb-3"><label class="form-label fw-bold small">ƒê·ªãa ch·ªâ</label><input type="text" name="address" class="form-control"></div>
            <div class="row mb-3"><div class="col-md-6"><label class="form-label fw-bold small">Ngu·ªìn</label><select name="source" class="form-select">{% for code, label in source_choices %}<option value="{{ code }}">{{ label }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label fw-bold small text-danger">D·ªãch v·ª• quan t√¢m</label><select name="skin_condition" class="form-select">{% for code, label in skin_choices %}<option value="{{ code }}">{{ label }}</option>{% endfor %}</select></div></div>
            <div class="mb-3"><label class="form-label fw-bold small text-primary">Ph√¢n b·ªï cho Telesale</label><select name="telesale_id" class="form-select border-primary fw-bold"><option value="">-- T·ª± ƒë·ªông (G√°n cho t√¥i) --</option>{% for staff in telesales_list %}<option value="{{ staff.id }}">{{ staff.last_name }} {{ staff.first_name }} ({{ staff.username }})</option>{% endfor %}</select></div>
            <div class="mb-3"><label class="form-label fw-bold small">Ghi ch√∫ ngu·ªìn</label><textarea name="note_telesale" class="form-control" rows="2"></textarea></div>
            <button type="submit" class="btn btn-primary fw-bold w-100 py-3">L∆ØU & PH√ÇN B·ªî</button>
          </div>
      </form>
    </div>
  </div>
</div>
<datalist id="cityOptions"><option value="H√† N·ªôi"><option value="TP. H·ªì Ch√≠ Minh"><option value="ƒê√† N·∫µng"><option value="H·∫£i Ph√≤ng"><option value="C·∫ßn Th∆°"><option value="B√¨nh D∆∞∆°ng"><option value="ƒê·ªìng Nai"><option value="Ngh·ªá An"></datalist>
<script>
    function toggleDateInput() {
        var status = document.getElementById('callStatusSelect').value;
        var dateInput = document.getElementById('appointmentDateInput');
        var inputField = dateInput.querySelector('input');
        if (status === 'BOOKED') { dateInput.style.display = 'block'; inputField.required = true; } 
        else { dateInput.style.display = 'none'; inputField.required = false; inputField.value = ''; }
    }
</script>
{% endblock %}