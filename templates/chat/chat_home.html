{% extends 'base.html' %}
{% load static %}

{% block title %}V-Chat Pro{% endblock %}

{% block content %}
<style>
    /* Layout */
    .chat-wrapper { height: calc(100vh - 130px); display: flex; gap: 0; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; background: white; }
    
    /* Sidebar Left */
    .chat-sidebar { width: 320px; background: #fff; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
    .room-list { flex: 1; overflow-y: auto; }
    
    /* Room Item in Sidebar */
    .room-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #fcfcfc; }
    .room-item:hover { background-color: #f1f3f5; }
    .room-item.active { background-color: #e3f2fd; border-left: 4px solid #3498db; }
    .room-avatar { width: 45px; height: 45px; background: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; margin-right: 12px; font-size: 1.1rem; flex-shrink: 0; }
    .group-avatar { background: #d1c4e9; color: #512da8; }
    
    /* Announcement Box */
    .announcement-section { background: #fff3cd; border-bottom: 1px solid #ffeeba; max-height: 150px; overflow-y: auto; }
    .ann-item { padding: 10px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
    .ann-item:hover { background: #ffe69c; }
    
    /* Main Chat Area */
    .chat-main { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
    .chat-header { padding: 10px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; height: 65px; background: #fff; }
    .messages-area { flex: 1; padding: 20px; overflow-y: auto; background-color: #f0f2f5; display: flex; flex-direction: column; gap: 5px; }
    
    /* Message Bubbles */
    .message { max-width: 70%; padding: 8px 12px; border-radius: 18px; position: relative; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; margin-bottom: 2px; }
    .message.sent { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 2px; }
    .message.received { align-self: flex-start; background: white; border: 1px solid #e0e0e0; border-bottom-left-radius: 2px; color: #333; margin-left: 35px; } /* Margin for avatar */
    
    .msg-avatar { width: 28px; height: 28px; border-radius: 50%; background: #ccc; position: absolute; left: -35px; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: white; font-weight: bold; }
    .msg-sender-name { font-size: 0.7rem; color: #777; margin-left: 35px; margin-bottom: 2px; margin-top: 5px; }
    
    .input-area { padding: 15px; background: white; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; align-items: center; }
</style>

<div class="chat-wrapper">
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-chat-dots-fill"></i> Chat</h5>
            <div>
                <button class="btn btn-light btn-sm rounded-circle border" title="T·∫°o nh√≥m" data-bs-toggle="modal" data-bs-target="#createGroupModal"><i class="bi bi-people-fill text-dark"></i></button>
                <button class="btn btn-light btn-sm rounded-circle border" title="Chat m·ªõi" data-bs-toggle="modal" data-bs-target="#newChatModal"><i class="bi bi-pencil-square text-primary"></i></button>
            </div>
        </div>

        {% if announcements %}
        <div class="announcement-section">
            {% for ann in announcements %}
            <div class="ann-item" onclick="showAnnouncement('{{ ann.title|escapejs }}', '{{ ann.content|escapejs }}')">
                <div class="d-flex align-items-center">
                    <i class="bi bi-megaphone-fill text-warning me-2"></i>
                    <div class="small fw-bold text-dark text-truncate">{{ ann.title }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="room-list" id="roomList">
            {% for room in rooms %}
            <div class="room-item" onclick="selectRoom({{ room.id }}, '{{ room.name|escapejs }}', {{ room.is_group|lower }})">
                <div class="room-avatar {% if room.is_group %}group-avatar{% endif %}">
                    {{ room.avatar }}
                </div>
                <div class="overflow-hidden w-100">
                    <div class="d-flex justify-content-between">
                        <div class="fw-bold text-dark text-truncate" style="max-width: 140px;">{{ room.name }}</div>
                        <small class="text-muted" style="font-size: 0.7rem;">{{ room.updated_at|date:"H:i" }}</small>
                    </div>
                    <div class="small text-muted text-truncate">{{ room.last_msg }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if request.user.role == 'ADMIN' or request.user.is_superuser %}
        <div class="p-2 border-top">
            <button class="btn btn-warning btn-sm w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#announcementModal">üì¢ T·∫°o Th√¥ng B√°o</button>
        </div>
        {% endif %}
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <span class="fw-bold fs-5 text-dark" id="chatTitle">Ch·ªçn h·ªôi tho·∫°i</span>
                <span class="badge bg-secondary ms-2" id="groupLabel" style="display:none;">Nh√≥m</span>
            </div>
            <div id="roomActions" style="display:none;">
                <button class="btn btn-light btn-sm border" onclick="openAddMemberModal()" title="Th√™m th√†nh vi√™n"><i class="bi bi-person-plus"></i></button>
            </div>
        </div>

        <div class="messages-area" id="messagesBox">
            <div class="text-center mt-5 text-muted"><i class="bi bi-chat-square-text display-1 opacity-25"></i><p class="mt-3">H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p></div>
        </div>

        <div class="input-area" id="inputArea" style="display: none;">
            <input type="text" id="msgInput" class="form-control rounded-pill bg-white border px-3 shadow-sm" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary rounded-circle shadow-sm" style="width: 40px; height: 40px;" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
        </div>
    </div>
</div>

<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">Chat v·ªõi ai?</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <input type="text" class="form-control mb-3" placeholder="T√¨m ki·∫øm..." onkeyup="filterUserList(this)">
                <div class="list-group">
                    {% for u in users %}
                    <button class="list-group-item list-group-item-action d-flex align-items-center user-select-item" onclick="createDirectChat({{ u.id }})">
                        <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3" style="width: 35px; height: 35px;">{{ u.username|slice:":1"|upper }}</div>
                        <div>
                            <div class="fw-bold">{{ u.last_name }} {{ u.first_name }}</div>
                            <small class="text-muted">{{ u.get_role_display }}</small>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">T·∫°o Nh√≥m M·ªõi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">T√™n nh√≥m</label>
                    <input type="text" id="newGroupName" class="form-control" placeholder="VD: Team Marketing">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Ch·ªçn th√†nh vi√™n</label>
                    <select id="newGroupMembers" class="form-select" multiple size="5">
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.last_name }} {{ u.first_name }} ({{ u.username }})</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu ng∆∞·ªùi</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="submitCreateGroup()">T·∫°o nh√≥m</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header"><h6 class="modal-title fw-bold">Th√™m v√†o nh√≥m</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <select id="addMemberSelect" class="form-select mb-3">
                    <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
                    {% for u in users %}
                    <option value="{{ u.id }}">{{ u.last_name }} {{ u.first_name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-success w-100" onclick="submitAddMember()">Th√™m ngay</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewAnnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning"><h5 class="modal-title fw-bold" id="viewAnnTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="viewAnnContent" style="white-space: pre-line;"></div>
        </div>
    </div>
</div>

{% if request.user.role == 'ADMIN' or request.user.is_superuser %}
<div class="modal fade" id="announcementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'create_announcement' %}" method="POST">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white"><h5 class="modal-title fw-bold">T·∫°o Th√¥ng B√°o</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" name="title" class="form-control mb-2" placeholder="Ti√™u ƒë·ªÅ" required>
                    <select name="target" class="form-select mb-2"><option value="ALL">T·∫•t c·∫£</option><option value="TELESALE">Telesale</option></select>
                    <textarea name="content" class="form-control" rows="3" required placeholder="N·ªôi dung..."></textarea>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-danger w-100">ƒêƒÉng</button></div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    let currentRoomId = null;
    let pollInterval = null;

    function selectRoom(roomId, roomName, isGroup) {
        currentRoomId = roomId;
        document.getElementById('chatTitle').innerText = roomName;
        document.getElementById('inputArea').style.display = 'flex';
        document.getElementById('roomActions').style.display = isGroup ? 'block' : 'none';
        document.getElementById('groupLabel').style.display = isGroup ? 'inline-block' : 'none';
        
        // Highlight active room
        document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        loadMessages();
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(loadMessages, 3000); // T·ª± ƒë·ªông load tin nh·∫Øn m·ªói 3s
    }

    function loadMessages() {
        if (!currentRoomId) return;
        fetch(`/chat/api/room/${currentRoomId}/messages/`)
            .then(res => res.json())
            .then(data => {
                if (data.error) return;
                const box = document.getElementById('messagesBox');
                const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
                box.innerHTML = '';
                
                let lastSenderId = null;

                data.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `message ${msg.is_me ? 'sent' : 'received'}`;
                    
                    // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi g·ª≠i n·∫øu l√† chat nh√≥m v√† ng∆∞·ªùi g·ª≠i kh√°c m√¨nh
                    let senderInfo = '';
                    if (!msg.is_me && msg.sender_id !== lastSenderId) {
                        senderInfo = `<div class="msg-sender-name">${msg.sender_name}</div>`;
                        // Th√™m avatar nh·ªè b√™n c·∫°nh
                        div.innerHTML += `<div class="msg-avatar" style="background-color: #${Math.floor(Math.random()*16777215).toString(16)}">${msg.avatar}</div>`;
                    }
                    
                    div.innerHTML += `${senderInfo}${msg.content}`;
                    div.title = msg.time;
                    box.appendChild(div);
                    lastSenderId = msg.sender_id;
                });

                if (isAtBottom || box.scrollTop === 0) box.scrollTop = box.scrollHeight;
            });
    }

    function sendMessage() {
        const input = document.getElementById('msgInput');
        const content = input.value.trim();
        if (!content || !currentRoomId) return;

        fetch('/chat/api/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 'room_id': currentRoomId, 'content': content })
        }).then(res => {
            if (res.ok) {
                input.value = '';
                loadMessages();
            }
        });
    }

    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    // --- API T·∫†O CHAT 1-1 ---
    function createDirectChat(userId) {
        fetch(`/chat/api/create-direct/${userId}/`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    // ƒê√≥ng modal, reload trang ho·∫∑c th√™m room v√†o list b·∫±ng JS (·ªü ƒë√¢y reload cho nhanh)
                    location.reload(); 
                }
            });
    }

    // --- API T·∫†O NH√ìM ---
    function submitCreateGroup() {
        const name = document.getElementById('newGroupName').value;
        const select = document.getElementById('newGroupMembers');
        const members = Array.from(select.selectedOptions).map(opt => opt.value);
        
        if (!name || members.length === 0) {
            alert("Vui l√≤ng nh·∫≠p t√™n nh√≥m v√† ch·ªçn th√†nh vi√™n!");
            return;
        }

        fetch('/chat/api/create-group/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 'group_name': name, 'members': members })
        }).then(res => res.json()).then(data => {
            if (data.status === 'ok') location.reload();
        });
    }

    // --- API TH√äM TH√ÄNH VI√äN ---
    function openAddMemberModal() {
        new bootstrap.Modal(document.getElementById('addMemberModal')).show();
    }

    function submitAddMember() {
        const userId = document.getElementById('addMemberSelect').value;
        if (!userId || !currentRoomId) return;

        fetch('/chat/api/add-member/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 'room_id': currentRoomId, 'user_id': userId })
        }).then(res => res.json()).then(data => {
            if (data.status === 'ok') {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    // --- XEM TH√îNG B√ÅO ---
    function showAnnouncement(title, content) {
        document.getElementById('viewAnnTitle').innerText = title;
        document.getElementById('viewAnnContent').innerText = content;
        new bootstrap.Modal(document.getElementById('viewAnnModal')).show();
    }
    
    function filterUserList(input) {
        const filter = input.value.toLowerCase();
        const items = document.querySelectorAll('.user-select-item');
        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(filter) ? 'flex' : 'none';
        });
    }
</script>
{% endblock %}