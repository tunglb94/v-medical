{% extends 'base.html' %}
{% load static %}

{% block title %}H·ªá th·ªëng Chat Pro{% endblock %}

{% block content %}
<style>
    /* --- LAYOUT CH√çNH --- */
    .chat-wrapper { height: calc(100vh - 130px); display: flex; gap: 15px; }
    
    /* C·ªòT TR√ÅI: DANH S√ÅCH USER */
    .user-sidebar { width: 300px; background: white; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .search-box { padding: 15px; border-bottom: 1px solid #f0f0f0; }
    .user-list { flex: 1; overflow-y: auto; }
    .user-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f8f9fa; }
    .user-item:hover { background-color: #f8f9fa; }
    .user-item.active { background-color: #e3f2fd; border-left: 4px solid #3498db; }
    
    .avatar-wrapper { position: relative; margin-right: 12px; }
    .user-avatar { width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; }
    .status-dot { width: 12px; height: 12px; background-color: #95a5a6; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
    .status-dot.online { background-color: #2ecc71; } /* Xanh l√°: Online */

    /* C·ªòT GI·ªÆA: KHUNG CHAT */
    .chat-main { flex: 1; background: white; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
    .chat-header { padding: 10px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    
    .messages-area { flex: 1; padding: 20px; overflow-y: auto; background-color: #f4f6f8; display: flex; flex-direction: column; gap: 8px; }
    
    .message { max-width: 75%; padding: 10px 15px; border-radius: 12px; position: relative; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; cursor: pointer; }
    .message:hover { opacity: 0.9; }
    .message.sent { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 2px; }
    .message.received { align-self: flex-start; background: white; border: 1px solid #dee2e6; border-bottom-left-radius: 2px; color: #333; }
    
    .msg-meta { font-size: 0.7rem; margin-top: 4px; display: flex; align-items: center; justify-content: flex-end; gap: 5px; opacity: 0.8; }
    .message.received .msg-meta { justify-content: flex-start; opacity: 0.6; }
    
    /* STYLE CHO PH·∫¶N REPLY */
    .reply-preview { display: none; background: #f8f9fa; padding: 10px 15px; border-left: 4px solid #3498db; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
    .reply-content-box { color: #666; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
    
    .reply-quote { display: block; margin-bottom: 5px; padding: 5px 8px; background: rgba(0,0,0,0.1); border-left: 3px solid rgba(255,255,255,0.5); border-radius: 4px; font-size: 0.8rem; opacity: 0.9; }
    .message.received .reply-quote { background: #f1f2f6; border-left: 3px solid #3498db; color: #555; }

    .input-area { padding: 15px; background: white; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; align-items: center; }
    
    /* C·ªòT PH·∫¢I: TH√îNG TIN & LINK (·∫®n hi·ªán) */
    .info-sidebar { width: 0; overflow: hidden; background: white; border-radius: 10px; transition: width 0.3s ease; border-left: 1px solid #f0f0f0; display: flex; flex-direction: column; }
    .info-sidebar.open { width: 280px; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
    .info-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; text-align: center; background: #f8f9fa; }
    .link-list { flex: 1; overflow-y: auto; padding: 15px; }
    .link-item { display: block; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; text-decoration: none; color: #3498db; font-size: 0.85rem; border: 1px solid #eee; word-break: break-all; }
    .link-item:hover { background: #e9ecef; text-decoration: underline; }
    .link-icon { margin-right: 5px; font-size: 1rem; }

    /* HIGHLIGHT T√åM KI·∫æM */
    .highlight { background-color: yellow; color: black; font-weight: bold; }
</style>

<div class="chat-wrapper">
    <div class="user-sidebar">
        <div class="search-box">
            <input type="text" id="userSearch" class="form-control form-control-sm rounded-pill" placeholder="üîç T√¨m nh√¢n vi√™n..." onkeyup="filterUsers()">
        </div>
        <div class="user-list" id="userListContainer">
            {% for u in users %}
            <div class="user-item" data-name="{{ u.last_name }} {{ u.first_name }} {{ u.username }}" onclick="selectUser('{{ u.id }}', '{{ u.last_name }} {{ u.first_name }}')">
                <div class="avatar-wrapper">
                    <div class="user-avatar">{{ u.username|slice:":1"|upper }}</div>
                    <div class="status-dot online"></div> 
                </div>
                <div class="overflow-hidden">
                    <div class="fw-bold text-dark text-truncate" style="max-width: 180px;">{{ u.last_name }} {{ u.first_name }}</div>
                    <div class="small text-muted">{{ u.get_role_display }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <span class="fw-bold fs-5 text-dark" id="chatTitle">Ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat</span>
            </div>
            <div class="d-flex gap-2" id="headerActions" style="display: none !important;">
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="msgSearch" class="form-control border-0 bg-light" placeholder="T√¨m n·ªôi dung..." onkeyup="searchMessages()">
                </div>
                <button class="btn btn-light btn-sm border" onclick="toggleInfoPanel()" title="Kho Link & Media">
                    <i class="bi bi-layout-sidebar-reverse"></i>
                </button>
            </div>
        </div>

        <div class="messages-area" id="messagesBox">
            <div class="text-center mt-5 text-muted">
                <i class="bi bi-chat-square-dots display-1 opacity-25"></i>
                <p class="mt-3">H√£y ch·ªçn m·ªôt ƒë·ªìng nghi·ªáp ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán.</p>
            </div>
        </div>

        <div id="replyPreview" class="reply-preview" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="bi bi-reply-fill text-primary me-2 fs-5"></i>
                <div>
                    <strong class="d-block small text-dark" id="replyTargetName">Tr·∫£ l·ªùi...</strong>
                    <span id="replyTargetContent" class="reply-content-box">N·ªôi dung tin nh·∫Øn...</span>
                </div>
            </div>
            <button class="btn btn-sm btn-link text-danger" onclick="cancelReply()"><i class="bi bi-x-lg"></i></button>
        </div>

        <div class="input-area" id="inputArea" style="display: none;">
            <input type="text" id="msgInput" class="form-control rounded-pill bg-light border-0 px-3" placeholder="Nh·∫≠p tin nh·∫Øn (Enter ƒë·ªÉ g·ª≠i)..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary rounded-circle" style="width: 40px; height: 40px;" onclick="sendMessage()">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>

    <div class="info-sidebar" id="infoPanel">
        <div class="info-header text-primary">
            <i class="bi bi-link-45deg me-2"></i>KHO LINK ƒê√É G·ª¨I
        </div>
        <div class="link-list" id="linkList">
            <div class="text-center text-muted small mt-3">Kh√¥ng c√≥ link n√†o.</div>
        </div>
    </div>
</div>

<script>
    let currentReceiverId = null;
    let pollInterval = null;
    let replyingToId = null; // ID tin nh·∫Øn ƒëang tr·∫£ l·ªùi

    // 1. CH·ªåN USER ƒê·ªÇ CHAT
    function selectUser(userId, userName) {
        currentReceiverId = userId;
        document.getElementById('chatTitle').innerText = userName;
        document.getElementById('inputArea').style.display = 'flex';
        document.getElementById('headerActions').style.setProperty('display', 'flex', 'important');
        cancelReply(); 
        
        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        loadMessages();
        
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(loadMessages, 3000);
    }

    // 2. T·∫¢I TIN NH·∫ÆN
    function loadMessages() {
        if (!currentReceiverId) return;
        const searchText = document.getElementById('msgSearch').value.toLowerCase();

        fetch(`/chat/api/get/${currentReceiverId}/`)
            .then(response => response.json())
            .then(data => {
                const box = document.getElementById('messagesBox');
                const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
                
                box.innerHTML = '';
                const linkContainer = document.getElementById('linkList');
                linkContainer.innerHTML = ''; 
                let hasLink = false;

                data.forEach(msg => {
                    let contentHtml = msg.content;
                    
                    // Regex t√¨m URL
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const links = msg.content.match(urlRegex);
                    
                    if (links) {
                        hasLink = true;
                        links.forEach(link => {
                            contentHtml = contentHtml.replace(link, `<a href="${link}" target="_blank" class="text-decoration-underline">${link}</a>`);
                            const linkItem = document.createElement('a');
                            linkItem.href = link; linkItem.target = "_blank"; linkItem.className = "link-item";
                            linkItem.innerHTML = `<i class="bi bi-globe link-icon"></i> ${link}`;
                            linkContainer.appendChild(linkItem);
                        });
                    }
                    
                    // Highlight t√¨m ki·∫øm
                    if (searchText && contentHtml.toLowerCase().includes(searchText)) {
                        contentHtml = contentHtml.replace(new RegExp(searchText, "gi"), (match) => `<span class="highlight">${match}</span>`);
                    }

                    // Tr·∫°ng th√°i ƒë√£ xem
                    let statusHtml = '';
                    if (msg.is_me) {
                        statusHtml = msg.is_read 
                            ? '<i class="bi bi-check2-all text-info" title="ƒê√£ xem"></i>' 
                            : '<i class="bi bi-check2 text-light" title="ƒê√£ g·ª≠i"></i>';
                    }

                    // X·ª≠ l√Ω Reply
                    let replyHtml = '';
                    if (msg.parent) {
                        replyHtml = `<div class="reply-quote">
                            <strong><i class="bi bi-reply-fill"></i> ${msg.parent.sender}</strong>: 
                            ${msg.parent.content}
                        </div>`;
                    }

                    const div = document.createElement('div');
                    div.className = `message ${msg.is_me ? 'sent' : 'received'}`;
                    div.title = "B·∫•m ƒë√∫p ƒë·ªÉ tr·∫£ l·ªùi";
                    div.ondblclick = () => startReply(msg.id, msg.is_me ? 'T√¥i' : 'ƒê·ªëi ph∆∞∆°ng', msg.content);

                    div.innerHTML = `
                        ${replyHtml}
                        ${contentHtml} 
                        <div class="msg-meta">
                            ${msg.time} ${statusHtml}
                        </div>
                    `;
                    box.appendChild(div);
                });

                if (!hasLink) {
                    linkContainer.innerHTML = '<div class="text-center text-muted small mt-3">Kh√¥ng c√≥ link n√†o.</div>';
                }

                if (isAtBottom || box.scrollTop === 0) box.scrollTop = box.scrollHeight;
            });
    }

    // --- LOGIC TR·∫¢ L·ªúI ---
    function startReply(msgId, senderName, content) {
        replyingToId = msgId;
        document.getElementById('replyTargetName').innerText = `Tr·∫£ l·ªùi ${senderName}`;
        document.getElementById('replyTargetContent').innerText = content;
        document.getElementById('replyPreview').style.display = 'flex';
        document.getElementById('msgInput').focus();
    }

    function cancelReply() {
        replyingToId = null;
        document.getElementById('replyPreview').style.display = 'none';
    }

    // 3. G·ª¨I TIN NH·∫ÆN
    function sendMessage() {
        const input = document.getElementById('msgInput');
        const content = input.value.trim();
        if (!content || !currentReceiverId) return;

        fetch('/chat/api/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 
                'receiver_id': currentReceiverId, 
                'content': content,
                'parent_id': replyingToId 
            })
        }).then(res => {
            if (res.ok) {
                input.value = '';
                cancelReply();
                loadMessages(); 
            }
        });
    }

    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    function filterUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('.user-item').forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            item.style.display = name.includes(query) ? 'flex' : 'none';
        });
    }

    function searchMessages() { loadMessages(); }
    function toggleInfoPanel() { document.getElementById('infoPanel').classList.toggle('open'); }
</script>
{% endblock %}