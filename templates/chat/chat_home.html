{% extends 'base.html' %}
{% load static %}

{% block title %}Hệ thống Chat Nội bộ{% endblock %}

{% block content %}
<style>
    .chat-container { height: calc(100vh - 130px); background: #fff; border-radius: 10px; overflow: hidden; display: flex; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .user-list { width: 280px; background: #f8f9fa; border-right: 1px solid #e9ecef; overflow-y: auto; }
    .user-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: 0.2s; display: flex; align-items: center; }
    .user-item:hover, .user-item.active { background: #e2e6ea; }
    .user-avatar { width: 40px; height: 40px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
    
    .chat-area { flex: 1; display: flex; flex-direction: column; background: white; }
    .chat-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; background: #fff; }
    .messages-box { flex: 1; padding: 20px; overflow-y: auto; background: #f1f2f6; display: flex; flex-direction: column; gap: 10px; }
    
    .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 0.95rem; }
    .message.sent { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 2px; }
    .message.received { align-self: flex-start; background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
    .msg-time { font-size: 0.7rem; margin-top: 5px; opacity: 0.7; text-align: right; }
    
    .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
</style>

<div class="chat-container">
    <div class="user-list">
        {% for u in users %}
        <div class="user-item" onclick="selectUser('{{ u.id }}', '{{ u.last_name }} {{ u.first_name }}')">
            <div class="user-avatar">{{ u.username|slice:":1"|upper }}</div>
            <div>
                <div class="fw-bold text-dark">{{ u.last_name }} {{ u.first_name }}</div>
                <div class="small text-muted">{{ u.get_role_display }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="chat-area">
        <div class="chat-header" id="chatHeader">Chọn một người để bắt đầu chat...</div>
        <div class="messages-box" id="messagesBox"></div>
        <div class="input-area" id="inputArea" style="display: none;">
            <input type="text" id="msgInput" class="form-control" placeholder="Nhập tin nhắn..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="sendMessage()"><i class="bi bi-send"></i></button>
        </div>
    </div>
</div>

<script>
    let currentReceiverId = null;
    let pollInterval = null;

    function selectUser(userId, userName) {
        currentReceiverId = userId;
        document.getElementById('chatHeader').innerText = "Chat với: " + userName;
        document.getElementById('inputArea').style.display = 'flex';
        
        // Active class
        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        loadMessages();
        
        // Polling: Cứ 3 giây tải tin nhắn mới 1 lần
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(loadMessages, 3000);
    }

    function loadMessages() {
        if (!currentReceiverId) return;
        
        fetch(`/chat/api/get/${currentReceiverId}/`)
            .then(response => response.json())
            .then(data => {
                const box = document.getElementById('messagesBox');
                const isAtBottom = box.scrollHeight - box.scrollTop === box.clientHeight;
                
                box.innerHTML = '';
                data.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `message ${msg.is_me ? 'sent' : 'received'}`;
                    div.innerHTML = `${msg.content} <div class="msg-time">${msg.time}</div>`;
                    box.appendChild(div);
                });

                if (isAtBottom || box.scrollTop === 0) {
                    box.scrollTop = box.scrollHeight;
                }
            });
    }

    function sendMessage() {
        const input = document.getElementById('msgInput');
        const content = input.value.trim();
        if (!content || !currentReceiverId) return;

        fetch('/chat/api/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ 'receiver_id': currentReceiverId, 'content': content })
        }).then(res => {
            if (res.ok) {
                input.value = '';
                loadMessages(); // Load lại ngay lập tức
            }
        });
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}