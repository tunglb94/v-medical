{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Hồ sơ: {{ customer.name }}{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link.active { font-weight:bold; border-top: 3px solid #3498db; background: #fff; border-bottom-color: transparent; color: #3498db; }
    .timeline-item { border-left: 2px solid #dee2e6; padding-left: 15px; padding-bottom: 20px; position: relative; }
    .timeline-item::before { content:''; position:absolute; left:-6px; top:5px; width:10px; height:10px; border-radius:50%; background:#adb5bd; }
    .timeline-item.success::before { background: #198754; }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'customer_list' %}" class="text-decoration-none text-muted fw-bold"><i class="bi bi-arrow-left me-1"></i> Quay lại danh sách</a>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card card-box h-100">
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width:80px; height:80px;">
                        <i class="bi bi-person-fill display-4 text-secondary"></i>
                    </div>
                    <h4 class="fw-bold mb-1">{{ customer.name }}</h4>
                    
                    <div class="mb-2">
                        {% if customer.ranking == 'DIAMOND' %}
                            <span class="badge bg-info"><i class="bi bi-gem me-1"></i>Thành viên Kim Cương</span>
                        {% elif customer.ranking == 'GOLD' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>Thành viên Vàng</span>
                        {% elif customer.ranking == 'SILVER' %}
                            <span class="badge bg-secondary"><i class="bi bi-star-half me-1"></i>Thành viên Bạc</span>
                        {% else %}
                            <span class="badge bg-light text-dark border">Thành viên Mới</span>
                        {% endif %}
                    </div>

                    <div class="text-muted fw-bold">{{ customer.phone }}</div>
                    
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <div class="bg-light p-2 rounded text-center" style="min-width: 100px;">
                            <div class="small text-muted text-uppercase" style="font-size: 0.7rem;">Doanh số (LTV)</div>
                            <div class="fw-bold text-success">{{ total_spent|intcomma }} đ</div>
                        </div>
                        <div class="bg-light p-2 rounded text-center" style="min-width: 100px;">
                            <div class="small text-muted text-uppercase" style="font-size: 0.7rem;">Lần đến</div>
                            <div class="fw-bold text-dark">{{ visit_count }}</div>
                        </div>
                    </div>
                </div>
                
                <hr class="opacity-25">
                
                <form method="POST">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-12 mb-2"><label class="small fw-bold text-muted">Họ Tên</label>{{ form.name }}</div>
                        <div class="col-6 mb-2"><label class="small fw-bold text-muted">SĐT</label>{{ form.phone }}</div>
                        <div class="col-6 mb-2"><label class="small fw-bold text-muted">Ngày sinh</label>{{ form.dob }}</div>
                        <div class="col-6 mb-2"><label class="small fw-bold text-muted">Tỉnh</label>{{ form.city }}</div>
                        <div class="col-6 mb-2"><label class="small fw-bold text-muted">Nguồn</label>{{ form.source }}</div>
                        <div class="col-12 mb-2"><label class="small fw-bold text-muted">Địa chỉ</label>{{ form.address }}</div>
                        <div class="col-12 mb-2"><label class="small fw-bold text-danger">Vấn đề Da</label>{{ form.skin_condition }}</div>
                        <div class="col-12 mb-3"><label class="small fw-bold text-muted">Ghi chú Telesale</label>{{ form.note_telesale }}</div>
                    </div>
                    <div class="d-grid"><button type="submit" class="btn btn-primary fw-bold">CẬP NHẬT HỒ SƠ</button></div>
                </form>

                {% if request.user.is_superuser %}
                <div class="text-center mt-3">
                    <form action="{% url 'customer_delete' customer.pk %}" method="POST" onsubmit="return confirm('Bạn chắc chắn muốn xóa khách này? Hành động không thể hoàn tác!');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link text-danger btn-sm text-decoration-none">Xóa khách hàng này</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card card-box h-100">
            <div class="card-header bg-white p-0 border-bottom">
                <ul class="nav nav-tabs card-header-tabs m-0 border-0 ps-3" id="myTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active py-3 px-4 rounded-0" data-bs-toggle="tab" data-bs-target="#logs">CSKH ({{ call_logs.count }})</button></li>
                    <li class="nav-item"><button class="nav-link py-3 px-4 rounded-0" data-bs-toggle="tab" data-bs-target="#appts">Lịch Hẹn ({{ appointments.count }})</button></li>
                    <li class="nav-item"><button class="nav-link py-3 px-4 rounded-0" data-bs-toggle="tab" data-bs-target="#orders">Đơn Hàng ({{ orders.count }})</button></li>
                </ul>
            </div>
            <div class="card-body bg-light p-3" style="max-height: 800px; overflow-y: auto;">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="logs">
                        <div class="bg-white p-4 rounded border shadow-sm">
                            {% for log in call_logs %}
                            <div class="timeline-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <strong class="text-dark small">{{ log.caller.username|default:"Hệ thống" }}</strong>
                                    <small class="text-muted">{{ log.call_time|date:"d/m H:i" }}</small>
                                </div>
                                <div class="mb-1"><span class="badge bg-light text-dark border">{{ log.get_status_display }}</span></div>
                                <p class="mb-0 small fst-italic text-secondary">"{{ log.note }}"</p>
                            </div>
                            {% empty %}<div class="text-center text-muted py-4">Chưa có lịch sử chăm sóc.</div>{% endfor %}
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="appts">
                        <div class="bg-white rounded border shadow-sm overflow-hidden">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="bg-light"><tr><th>Ngày</th><th>Trạng thái</th><th>Người tạo</th><th>BS/KTV</th></tr></thead>
                                <tbody>
                                    {% for app in appointments %}
                                    <tr>
                                        <td class="fw-bold text-primary">{{ app.appointment_date|date:"d/m H:i" }}</td>
                                        <td>{{ app.get_status_display }}</td>
                                        <td>{{ app.created_by.username }}</td>
                                        <td><small>BS: {{ app.assigned_doctor.last_name|default:"--" }}</small></td>
                                    </tr>
                                    {% empty %}<tr><td colspan="4" class="text-center text-muted py-4">Chưa có lịch hẹn.</td></tr>{% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="orders">
                        <div class="bg-white rounded border shadow-sm overflow-hidden">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="bg-success text-white"><tr><th>Ngày</th><th>Dịch vụ</th><th>Thành tiền</th><th>Sale</th><th></th></tr></thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr>
                                        <td>{{ order.created_at|date:"d/m/Y" }}</td>
                                        <td class="fw-bold">{{ order.treatment_name }}</td>
                                        <td class="text-danger fw-bold">{{ order.total_amount|intcomma }} đ</td>
                                        <td>{{ order.sale_consultant.username }}</td>
                                        <td><a href="{% url 'print_invoice' order.id %}" target="_blank" class="text-dark"><i class="bi bi-printer"></i></a></td>
                                    </tr>
                                    {% empty %}<tr><td colspan="5" class="text-center text-muted py-4">Chưa có đơn hàng.</td></tr>{% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}