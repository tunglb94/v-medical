{% load static %}
{% load humanize %} <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hồ sơ: {{ customer.name }} - V-Medical</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body{background:#f0f2f5;font-family:'Segoe UI',sans-serif;}
        .nav-tabs .nav-link.active {font-weight:bold; border-top: 3px solid #0d6efd; background: #fff; border-bottom-color: transparent;}
        .timeline-item { border-left: 2px solid #dee2e6; padding-left: 15px; position: relative; padding-bottom: 20px;}
        .timeline-item::before { content:''; position:absolute; left:-6px; top:5px; width:10px; height:10px; border-radius:50%; background:#adb5bd; }
        .timeline-item.success::before { background: #198754; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary px-3 mb-4 shadow-sm">
  <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
      <img src="{% static 'images/logo.png' %}" alt="Logo" height="40" class="d-inline-block align-text-top me-2 bg-white rounded p-1">
      KHÁCH HÀNG 360°
  </a>
  <div class="ms-auto text-white d-flex align-items-center">
      <a href="/" class="btn btn-sm btn-outline-light me-2">Home</a>
      <a href="{% url 'logout' %}" class="btn btn-sm btn-danger"><i class="bi bi-box-arrow-right"></i></a>
  </div>
</nav>

<div class="container-fluid px-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="{% url 'customer_list' %}" class="btn btn-outline-secondary fw-bold"><i class="bi bi-arrow-left me-2"></i> Quay lại danh sách</a>
        {% if request.user.is_superuser %}
        <form action="{% url 'customer_delete' customer.pk %}" method="POST" onsubmit="return confirm('Bạn chắc chắn muốn xóa?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash me-1"></i> Xóa khách</button>
        </form>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width:80px; height:80px;">
                            <i class="bi bi-person-fill display-4 text-secondary"></i>
                        </div>
                        <h4 class="fw-bold mb-0">{{ customer.name }}</h4>
                        
                        <div class="mb-2 mt-1">
                            {% if customer.ranking == 'DIAMOND' %}
                                <span class="badge bg-info text-white"><i class="bi bi-gem me-1"></i>Thành viên Kim Cương</span>
                            {% elif customer.ranking == 'GOLD' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>Thành viên Vàng</span>
                            {% elif customer.ranking == 'SILVER' %}
                                <span class="badge bg-secondary text-white"><i class="bi bi-star-half me-1"></i>Thành viên Bạc</span>
                            {% else %}
                                <span class="badge bg-light text-dark border">Thành viên Mới</span>
                            {% endif %}
                        </div>

                        <div class="text-muted fw-bold">{{ customer.phone }}</div>
                        
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <div class="badge bg-success p-2">
                                <div class="small opacity-75">LTV (Doanh số)</div>
                                <div class="fs-6">{{ total_spent|intcomma }} đ</div>
                            </div>
                            <div class="badge bg-info text-dark p-2">
                                <div class="small opacity-75">Lần đến</div>
                                <div class="fs-6">{{ visit_count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="opacity-25">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row g-2">
                            <div class="col-12 mb-2"><label class="small fw-bold">Họ Tên</label>{{ form.name }}</div>
                            <div class="col-6 mb-2"><label class="small fw-bold">SĐT</label>{{ form.phone }}</div>
                            <div class="col-6 mb-2"><label class="small fw-bold">Ngày sinh</label>{{ form.dob }}</div>
                            <div class="col-6 mb-2"><label class="small fw-bold">Tỉnh</label>{{ form.city }}</div>
                            <div class="col-6 mb-2"><label class="small fw-bold">Nguồn</label>{{ form.source }}</div>
                            <div class="col-12 mb-2"><label class="small fw-bold">Địa chỉ</label>{{ form.address }}</div>
                            <div class="col-12 mb-2"><label class="small fw-bold text-danger">Da</label>{{ form.skin_condition }}</div>
                            <div class="col-12 mb-3"><label class="small fw-bold">Note</label>{{ form.note_telesale }}</div>
                        </div>
                        <div class="d-grid"><button type="submit" class="btn btn-primary fw-bold py-2">LƯU THAY ĐỔI</button></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white p-0 border-bottom">
                    <ul class="nav nav-tabs card-header-tabs m-0 border-0 ps-3" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active py-3 px-4 rounded-0" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs">CSKH ({{ call_logs.count }})</button></li>
                        <li class="nav-item"><button class="nav-link py-3 px-4 rounded-0" id="appts-tab" data-bs-toggle="tab" data-bs-target="#appts">Lịch Hẹn ({{ appointments.count }})</button></li>
                        <li class="nav-item"><button class="nav-link py-3 px-4 rounded-0" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders">Đơn Hàng ({{ orders.count }})</button></li>
                    </ul>
                </div>
                <div class="card-body bg-light" style="max-height: 800px; overflow-y: auto;">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="logs">
                            <div class="bg-white p-4 rounded border shadow-sm">
                                {% for log in call_logs %}
                                <div class="timeline-item">
                                    <div class="d-flex justify-content-between">
                                        <strong class="text-dark">{{ log.caller.username|default:"Hệ thống" }}</strong>
                                        <small class="text-muted">{{ log.call_time|date:"d/m H:i" }}</small>
                                    </div>
                                    <div class="mb-1"><span class="badge bg-light text-dark border">{{ log.get_status_display }}</span></div>
                                    <p class="mb-0 small fst-italic text-secondary">"{{ log.note }}"</p>
                                </div>
                                {% empty %}<div class="text-center text-muted">Chưa có lịch sử.</div>{% endfor %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="appts">
                            <div class="table-responsive bg-white rounded border shadow-sm">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light"><tr><th>Ngày</th><th>Trạng thái</th><th>Người tạo</th><th>Phụ trách</th></tr></thead>
                                    <tbody>
                                        {% for app in appointments %}
                                        <tr>
                                            <td class="fw-bold text-primary">{{ app.appointment_date|date:"d/m H:i" }}</td>
                                            <td>{{ app.get_status_display }}</td>
                                            <td>{{ app.created_by.username }}</td>
                                            <td><div class="small">BS: {{ app.assigned_doctor.last_name|default:"--" }}</div></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="orders">
                            <div class="table-responsive bg-white rounded border shadow-sm">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="bg-success text-white"><tr><th>Ngày</th><th>Dịch vụ</th><th>Tiền</th><th>Sale</th><th>In</th></tr></thead>
                                    <tbody>
                                        {% for order in orders %}
                                        <tr>
                                            <td>{{ order.created_at|date:"d/m/Y" }}</td>
                                            <td class="fw-bold">{{ order.treatment_name }}</td>
                                            <td class="text-danger fw-bold">{{ order.total_amount|intcomma }} đ</td>
                                            <td>{{ order.sale_consultant.username }}</td>
                                            <td><a href="{% url 'print_invoice' order.id %}" target="_blank"><i class="bi bi-printer"></i></a></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>