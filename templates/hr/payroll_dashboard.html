{% extends 'base.html' %}
{% load humanize %}

{% block title %}Bảng Lương & Hoa Hồng{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-dark">BẢNG LƯƠNG & HOA HỒNG</h4>
    <div class="d-flex gap-2">
        <form method="GET">
            <input type="month" name="month" class="form-control" value="{{ selected_month }}" onchange="this.form.submit()">
        </form>
        <form method="POST">
            {% csrf_token %}
            <button class="btn btn-success fw-bold shadow-sm"><i class="bi bi-calculator me-2"></i>TÍNH LƯƠNG & HH</button>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card card-box bg-primary text-white p-3">
            <h6 class="text-white-50 small text-uppercase">Tổng thực chi tháng này</h6>
            <h3 class="fw-bold mb-0">{{ total_payout|intcomma }} đ</h3>
        </div>
    </div>
</div>

<div class="card card-box">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary small">
                <tr>
                    <th class="ps-3">Nhân viên</th>
                    <th class="text-end">Lương cứng</th>
                    <th class="text-center">Công</th>
                    <th class="text-end">Doanh số</th>
                    <th class="text-end">Hoa hồng</th>
                    <th class="text-end">Phụ cấp/Thưởng</th>
                    <th class="text-end pe-3 text-danger fw-bold">THỰC LĨNH</th>
                </tr>
            </thead>
            <tbody>
                {% for slip in slips %}
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold text-dark">{{ slip.user.last_name }} {{ slip.user.first_name }}</div>
                        <div class="small text-muted">{{ slip.user.get_role_display }}</div>
                    </td>
                    <td class="text-end">{{ slip.base_salary_lock|intcomma }}</td>
                    <td class="text-center fw-bold">{{ slip.actual_work_days|floatformat:1 }}</td>
                    
                    <td class="text-end text-primary">
                        {{ slip.sales_revenue|intcomma }}
                    </td>
                    <td class="text-end text-success fw-bold">
                        {{ slip.commission_amount|intcomma }}
                        <div class="small text-muted" style="font-size: 10px;">({{ slip.commission_rate_lock }}%)</div>
                    </td>

                    <td class="text-end">
                        {% if slip.allowance_lock > 0 %}<span>+{{ slip.allowance_lock|intcomma }} (PC)</span><br>{% endif %}
                        {% if slip.bonus > 0 %}<span class="text-success">+{{ slip.bonus|intcomma }}</span><br>{% endif %}
                        {% if slip.deduction > 0 %}<span class="text-danger">-{{ slip.deduction|intcomma }}</span>{% endif %}
                    </td>
                    <td class="text-end pe-3 fw-bold text-danger fs-5">{{ slip.total_salary|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center py-5 text-muted">Chưa có bảng lương tháng này. Nhấn "TÍNH LƯƠNG" để bắt đầu.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}