{% extends 'base.html' %}
{% load static %}

{% block title %}Lịch dịch vụ{% endblock %}

{% block extra_css %}
<style>
    /* Custom style for calendar */
    #calendar {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        min-height: 700px; /* Ensure height so it's not collapsed */
    }
    .fc-header-toolbar {
        margin-bottom: 1.5em !important;
    }
    .fc-event {
        cursor: pointer;
    }
    /* Status colors */
    .status-scheduled { border-left: 4px solid #3b82f6 !important; background-color: #eff6ff; color: #1e3a8a; }
    .status-confirmed { border-left: 4px solid #10b981 !important; background-color: #ecfdf5; color: #064e3b; }
    .status-completed { border-left: 4px solid #6b7280 !important; background-color: #f3f4f6; color: #1f2937; }
    .status-cancelled { border-left: 4px solid #ef4444 !important; background-color: #fef2f2; color: #7f1d1d; }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Lịch Dịch Vụ & Nhắc Hẹn</h1>
            <p class="text-sm text-gray-500">Quản lý lịch hẹn khách hàng và lịch làm việc kỹ thuật viên</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="calendar.refetchEvents()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center">
                <i class="fas fa-sync-alt mr-2"></i> Làm mới
            </button>
            <a href="{% url 'booking_create' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 flex items-center">
                <i class="fas fa-plus mr-2"></i> Đặt lịch mới
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter mr-2 text-blue-500"></i> Bộ lọc hiển thị
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Kỹ thuật viên</label>
                        <select id="filter-technician" class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Tất cả nhân viên</option>
                            {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.get_full_name|default:tech.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Dịch vụ</label>
                        <select id="filter-service" class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Tất cả dịch vụ</option>
                            {% for service in services %}
                            <option value="{{ service.id }}">{{ service.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-bell mr-2 text-yellow-500"></i> Cần nhắc lịch (Hôm nay)
                </h3>
                <div class="space-y-3 overflow-y-auto max-h-[400px]">
                    {% if upcoming_appointments %}
                        {% for appt in upcoming_appointments %}
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{{ appt.appointment_time|time:"H:i" }}</span>
                                <span class="text-xs text-gray-400">{{ appt.service.name }}</span>
                            </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium text-gray-800">{{ appt.customer.name }}</p>
                                <p class="text-xs text-gray-500"><i class="fas fa-phone-alt text-[10px] mr-1"></i> {{ appt.customer.phone }}</p>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <a href="tel:{{ appt.customer.phone }}" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">
                                    <i class="fas fa-phone mr-1"></i> Gọi
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-gray-400 text-center py-4">Không có lịch cần nhắc hôm nay.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-sm p-1 h-full">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<div id="eventModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-calendar-check text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Chi tiết lịch hẹn</h3>
                        <div class="mt-4 space-y-2 text-sm text-gray-600">
                            <p><strong>Khách hàng:</strong> <span id="modal-customer"></span></p>
                            <p><strong>Dịch vụ:</strong> <span id="modal-service"></span></p>
                            <p><strong>Thời gian:</strong> <span id="modal-time"></span></p>
                            <p><strong>KTV:</strong> <span id="modal-tech"></span></p>
                            <p><strong>Ghi chú:</strong> <span id="modal-note"></span></p>
                            <div class="mt-2 pt-2 border-t">
                                <label class="block text-xs font-semibold text-gray-700">Trạng thái:</label>
                                <span id="modal-status" class="px-2 py-1 rounded text-xs font-bold mt-1 inline-block"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <a id="modal-edit-link" href="#" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Cập nhật
                </a>
                <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
    var calendar; // Global variable

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var filterTech = document.getElementById('filter-technician');
        var filterService = document.getElementById('filter-service');

        // Khởi tạo Calendar
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', // Mặc định xem theo tháng
            locale: 'vi', // Tiếng Việt
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            buttonText: {
                today: 'Hôm nay',
                month: 'Tháng',
                week: 'Tuần',
                list: 'Danh sách'
            },
            navLinks: true, // Cho phép click vào ngày để xem chi tiết ngày đó
            editable: false, // Không cho kéo thả trực tiếp (để tránh lỗi logic phức tạp)
            dayMaxEvents: true, // Hiển thị "xem thêm" nếu quá nhiều lịch trong 1 ngày
            
            // Nguồn dữ liệu (gọi API từ Django)
            events: {
                url: '/service-calendar/events/', // Endpoint JSON
                failure: function() {
                    alert('Không thể tải dữ liệu lịch hẹn!');
                }
            },

            // Sự kiện khi click vào lịch hẹn
            eventClick: function(info) {
                // Ngăn chặn hành động mặc định (như mở link)
                info.jsEvent.preventDefault(); 
                
                // Hiển thị Modal chi tiết
                showModal(info.event);
            },

            // Tùy chỉnh hiển thị class cho từng sự kiện dựa trên trạng thái
            eventClassNames: function(arg) {
                var status = arg.event.extendedProps.status_code || 'SCHEDULED';
                return ['status-' + status.toLowerCase()];
            }
        });

        calendar.render();

        // --- Logic Bộ lọc ---
        function refreshCalendar() {
            // FullCalendar tự động gửi tham số GET (start, end)
            // Ta sẽ xóa nguồn cũ và thêm nguồn mới với tham số filter
            var techId = filterTech.value;
            var serviceId = filterService.value;
            
            // Cách đơn giản nhất: Reload lại source với extraParams
            var newSource = {
                url: '/service-calendar/events/',
                extraParams: {
                    technician_id: techId,
                    service_id: serviceId
                }
            };

            // Xóa tất cả event cũ và fetch lại
            calendar.removeAllEventSources();
            calendar.addEventSource(newSource);
        }

        // Lắng nghe sự kiện thay đổi bộ lọc
        filterTech.addEventListener('change', refreshCalendar);
        filterService.addEventListener('change', refreshCalendar);
    });

    // --- Modal Functions ---
    function showModal(event) {
        var props = event.extendedProps;
        document.getElementById('modal-customer').textContent = props.customer_name || 'Khách lẻ';
        document.getElementById('modal-service').textContent = event.title;
        document.getElementById('modal-time').textContent = event.start.toLocaleString('vi-VN');
        document.getElementById('modal-tech').textContent = props.technician_name || 'Chưa gán';
        document.getElementById('modal-note').textContent = props.notes || 'Không có';
        
        var statusEl = document.getElementById('modal-status');
        statusEl.textContent = props.status_display;
        
        // Màu sắc trạng thái modal
        statusEl.className = 'px-2 py-1 rounded text-xs font-bold mt-1 inline-block ';
        if (props.status_code === 'CONFIRMED') statusEl.classList.add('bg-green-100', 'text-green-800');
        else if (props.status_code === 'COMPLETED') statusEl.classList.add('bg-gray-100', 'text-gray-800');
        else if (props.status_code === 'CANCELLED') statusEl.classList.add('bg-red-100', 'text-red-800');
        else statusEl.classList.add('bg-blue-100', 'text-blue-800');

        // Link edit
        var editLink = document.getElementById('modal-edit-link');
        // Giả sử URL edit là /bookings/<id>/change/
        // Cần truyền ID từ backend, ở đây ta dùng dummy hoặc logic JS string replace
        // Tốt nhất là backend trả về edit_url trong props
        if (props.edit_url) {
            editLink.href = props.edit_url;
            editLink.classList.remove('hidden');
        } else {
            editLink.classList.add('hidden');
        }

        document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('eventModal').classList.add('hidden');
    }
</script>
{% endblock %}