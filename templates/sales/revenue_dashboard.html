{% load static %}
{% load humanize %} <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Doanh Thu - V-Medical Clinic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); color: white; }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); color: white; }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); color: white; }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); color: white; }
        .bg-gradient-purple { background: linear-gradient(45deg, #6f42c1, #59359a); color: white; }
        .chart-container { position: relative; margin: auto; height: 280px; width: 100%; }
        @media (max-width: 768px) { .chart-container { height: 220px; } }
        .table-sm td, .table-sm th { font-size: 0.9rem; padding: 0.5rem; }
        .table-card-header { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; background-color: #f8f9fc; color: #5a5c69; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 mb-4 shadow-sm">
  <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
      <img src="{% static 'images/logo.png' %}" alt="Logo" height="40" class="d-inline-block align-text-top me-2 bg-white rounded p-1">
      BÁO CÁO V-MEDICAL
  </a>
  <div class="ms-auto d-flex align-items-center gap-2">
      <a href="/" class="btn btn-sm btn-outline-light">Telesale</a>
      <a href="/reception/" class="btn btn-sm btn-outline-light">Lễ tân</a>
      <a href="{% url 'logout' %}" class="btn btn-sm btn-danger"><i class="bi bi-power"></i></a>
  </div>
</nav>

<div class="container-fluid px-4 pb-5">
    
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-6 col-md-2">
                    <label class="form-label small fw-bold text-muted">Từ ngày</label>
                    <input type="date" name="date_start" class="form-control" value="{{ date_start }}">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small fw-bold text-muted">Đến ngày</label>
                    <input type="date" name="date_end" class="form-control" value="{{ date_end }}">
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small fw-bold text-muted">Bác sĩ</label>
                    <select name="doctor_id" class="form-select">
                        <option value="">-- Tất cả --</option>
                        {% for doc in doctors %}
                        <option value="{{ doc.id }}" {% if selected_doctor == doc.id %}selected{% endif %}>{{ doc.last_name }} {{ doc.first_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label small fw-bold text-muted">Sale</label>
                    <select name="consultant_id" class="form-select">
                        <option value="">-- Tất cả --</option>
                        {% for sale in consultants %}
                        <option value="{{ sale.id }}" {% if selected_consultant == sale.id %}selected{% endif %}>{{ sale.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary fw-bold"><i class="bi bi-filter"></i> Xem Báo Cáo</button>
                </div>
            </form>
        </div>
    </div>

    <h5 class="fw-bold text-secondary mb-3 border-bottom pb-2"><i class="bi bi-coin me-2"></i>HIỆU QUẢ KINH DOANH</h5>
    
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card card-stat bg-gradient-primary h-100">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75">Tổng Doanh Thu</h6>
                    <div class="display-6 fw-bold">{{ total_revenue|intcomma }} đ</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="card card-stat bg-gradient-success h-100">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75">Số Đơn Hàng</h6>
                    <div class="display-6 fw-bold">{{ total_orders }}</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="card card-stat bg-gradient-info h-100">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75">Giá Trị TB (AOV)</h6>
                    <div class="display-6 fw-bold">{{ avg_order_value|intcomma }} đ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 col-lg-8 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-3">Biểu đồ Doanh thu</div>
                <div class="card-body"><div class="chart-container"><canvas id="revenueChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-3">Top Doanh Số Sale</div>
                <div class="card-body"><div class="chart-container"><canvas id="saleChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h5 class="fw-bold text-secondary mb-3 border-bottom pb-2 mt-4"><i class="bi bi-pie-chart me-2"></i>PHÂN TÍCH HIỆU QUẢ</h5>
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-2 small text-center">CHẤT LƯỢNG DATA</div>
                <div class="card-body"><div class="chart-container" style="height: 200px;"><canvas id="teleStatusChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-2 small text-center">NGUỒN KHÁCH HÀNG</div>
                <div class="card-body"><div class="chart-container" style="height: 200px;"><canvas id="sourceChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-2 small text-center">VẤN ĐỀ VỀ DA</div>
                <div class="card-body"><div class="chart-container" style="height: 200px;"><canvas id="skinChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h5 class="fw-bold text-secondary mb-3 border-bottom pb-2 mt-5"><i class="bi bi-table me-2"></i>CHI TIẾT SỐ LIỆU</h5>
    <div class="row g-3 mb-5">
        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header table-card-header border-bottom-0">Doanh số Sale</div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead><tr><th>NV</th><th class="text-end">Tiền</th></tr></thead>
                        <tbody>
                            {% for item in sale_table %}
                            <tr><td>{{ item.name }}</td><td class="text-end fw-bold text-success">{{ item.amount|intcomma }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header table-card-header border-bottom-0">Kết quả gọi ({{ total_calls }})</div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead><tr><th>Trạng thái</th><th class="text-end">SL</th></tr></thead>
                        <tbody>{% for item in tele_table %}<tr><td>{{ item.status }}</td><td class="text-end fw-bold">{{ item.count }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header table-card-header border-bottom-0">Nguồn khách</div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead><tr><th>Nguồn</th><th class="text-end">SL</th></tr></thead>
                        <tbody>{% for item in source_table %}<tr><td>{{ item.name }}</td><td class="text-end fw-bold">{{ item.count }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header table-card-header border-bottom-0">Tỉnh thành</div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead><tr><th>Tỉnh</th><th class="text-end">SL</th></tr></thead>
                        <tbody>{% for item in city_table %}<tr><td>{{ item.name }}</td><td class="text-end fw-bold">{{ item.count }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-white fw-bold py-3 text-primary">
            <i class="bi bi-list-check me-2"></i>NHẬT KÝ ĐƠN HÀNG
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary sticky-top">
                        <tr>
                            <th class="ps-3">Mã</th>
                            <th>Ngày</th>
                            <th>Khách</th>
                            <th>Dịch vụ</th>
                            <th>Nhân sự</th>
                            <th class="text-end pe-3">Tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td class="ps-3 fw-bold text-secondary">#{{ order.id }}</td>
                            <td>{{ order.created_at|date:"d/m H:i" }}</td>
                            <td>
                                <div class="fw-bold">{{ order.customer.name }}</div>
                                <div class="small text-muted">{{ order.customer.phone }}</div>
                            </td>
                            <td>{{ order.treatment_name }}</td>
                            <td>
                                <div class="small">BS: {{ order.appointment.assigned_doctor.last_name|default:"--" }}</div>
                                <div class="small">Sale: {{ order.sale_consultant.username|default:"--" }}</div>
                            </td>
                            <td class="text-end pe-3 fw-bold text-success">
                                {{ order.total_amount|intcomma }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center p-4 text-muted">Không có dữ liệu</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{{ chart_dates|json_script:"j-dates" }}
{{ chart_revenues|json_script:"j-revenues" }}
{{ sale_labels|json_script:"j-sale-labels" }}
{{ sale_data|json_script:"j-sale-data" }}
{{ mkt_source_labels|json_script:"j-src-lbl" }}
{{ mkt_source_data|json_script:"j-src-data" }}
{{ mkt_skin_labels|json_script:"j-skin-lbl" }}
{{ mkt_skin_data|json_script:"j-skin-data" }}
{{ mkt_age_labels|json_script:"j-age-lbl" }}
{{ mkt_age_data|json_script:"j-age-data" }}
{{ mkt_city_labels|json_script:"j-city-lbl" }}
{{ mkt_city_data|json_script:"j-city-data" }}
{{ tele_status_labels|json_script:"j-tele-lbl" }}
{{ tele_status_data|json_script:"j-tele-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function getData(id) { return JSON.parse(document.getElementById(id).textContent); }
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2] } }, x: { grid: { display: false } } } };
        const pieOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } } };

        new Chart(document.getElementById('revenueChart'), { type: 'line', data: { labels: getData('j-dates'), datasets: [{ label: 'Doanh thu', data: getData('j-revenues'), borderColor: '#4e73df', backgroundColor: 'rgba(78, 115, 223, 0.1)', fill: true, tension: 0.3 }] }, options: chartOptions });
        new Chart(document.getElementById('saleChart'), { type: 'bar', data: { labels: getData('j-sale-labels'), datasets: [{ label: 'Doanh số', data: getData('j-sale-data'), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }] }, options: chartOptions });
        new Chart(document.getElementById('teleStatusChart'), { type: 'pie', data: { labels: getData('j-tele-lbl'), datasets: [{ data: getData('j-tele-data'), backgroundColor: ['#1cc88a', '#f6c23e', '#858796', '#e74a3b', '#36b9cc'] }] }, options: pieOptions });
        new Chart(document.getElementById('sourceChart'), { type: 'pie', data: { labels: getData('j-src-lbl'), datasets: [{ data: getData('j-src-data'), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }] }, options: { plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false } });
        new Chart(document.getElementById('skinChart'), { type: 'doughnut', data: { labels: getData('j-skin-lbl'), datasets: [{ data: getData('j-skin-data'), backgroundColor: ['#e74a3b', '#f6c23e', '#4e73df', '#1cc88a', '#36b9cc'] }] }, options: { plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false } });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>